mindDesigner.prototype.events.addEventListener("savelocal",function(){$("#savetip").text("所有更改已保存");mindUI.isOperated=true});mindDesigner.prototype.events.addEventListener("savelocalsuccess",function(){$("#savetip").text("")});mindDesigner.prototype.events.addEventListener("documentkeydown",function(){$(document).on("keydown.hotkey",".mind-image-dlg, .header-item .title,.mind-dock-right-con, .mind-menu-list,.mind-help-con,.mind-dlg",function(a){a.stopPropagation()});$(document).on("mousemove.hotkey",".mind-image-dlg, .header-item .title,.mind-dock-right-con, .mind-menu-list,.mind-help-con,.mind-dlg",function(a){a.stopPropagation()})});mindDesigner.prototype.events.addEventListener("changeHeadColor",function(a){if(a=="#ffffff"||a=="rgb(255, 255, 255)"){$("header").css({background:"#f5f5f5"})}else{$("header").css({background:"#ffffff"})}});mindDesigner.prototype.events.addEventListener("undoStackChanged",function(b){var a=$(".header-item.undo");if(b==0){a.addClass("mind-disable")}else{a.removeClass("mind-disable")}});mindDesigner.prototype.events.addEventListener("redoStackChanged",function(b){var a=$(".header-item.redo");if(b==0){a.addClass("mind-disable")}else{a.removeClass("mind-disable")}});mindDesigner.prototype.events.addEventListener("loadsuccess",function(b){var a=b.styles;if(a.background!="#ffffff"&&a.background!="rgb(255,255,255)"){$(".mind-dock-right").css("right","16px")}else{$(".mind-dock-right").css("right","10px")}var c=chartTitle||"中心主题";$(".header-item .title").text(c);chartTitle=c;chartId=b.opts.chartId;setTimeout(function(){$("#mind-loading").fadeOut(200,function(){$("#mind-loading").remove()})},200)});mindDesigner.prototype.events.addEventListener("hidepopeditor",function(){$(".pop-editor").remove()});mindDesigner.prototype.events.addEventListener("setDock",function(a){mindUI.initDock(a)});mindDesigner.prototype.events.addEventListener("openNote",function(b){var a=$(".mind-dock-right").children("div[tit=mind-dock-right-remark]");if($(".mind-dock-right-con").css("opacity")!=0){return}a.trigger("click")});mindDesigner.prototype.events.addEventListener("saveOnline",function(a){mindUI.addHistory(function(){$.showTitleTip("已经为您保存一个历史版本",4000,"div[tit=mind-dock-right-history]","left")})});mindDesigner.prototype.events.addEventListener("showThemeOperate",function(a){mindUI.showThemeOperate(a)});mindDesigner.prototype.events.addEventListener("toNew",function(a){mindUI.createNew()});mindDesigner.prototype.events.addEventListener("hideElements",function(){$(".mind-slide-selection").hide();$(".mind-slide-con").hide();$("header").hide();$(".mind-slider-dlg").hide()});mindDesigner.prototype.events.addEventListener("showElements",function(){$(".mind-slider-close").trigger("click")});mindDesigner.prototype.events.addEventListener("saveSliders",function(a){mindColla.saveSliders(a)});mindDesigner.prototype.events.addEventListener("setContextMenu",function(b){var a=$(".mind-context-menu-content").find("ul");a.find(".disable").removeClass("disable");var c=mind.model.clipboard.list;if(b.root){a.children("[op=insert-parent]").addClass("disable");a.children("[op=insert-siblings]").addClass("disable");a.children("[op=cut]").addClass("disable");a.children("[op=delete]").addClass("disable")}if(b.pos){a.children("[op=insert-parent]").addClass("disable");a.children("[op=insert-siblings]").addClass("disable")}if(c.length==0){a.children("[op=paste]").addClass("disable")}});mindDesigner.prototype.events.addEventListener("showuploading",function(){mindUI.showUploading()});mindDesigner.prototype.events.addEventListener("hideuploading",function(){mindUI.hideUploading()});$(document).ready(function(){$(".header-item.icon.down").on("click",function(g){var f=$(this),h=$(".mind-title-menu");mindUI.showMenu(f,h)});$("#mind-designer-back").on("click",function(){window.location.href="/diagraming/back?id="+chartId});$(".header-item.icon.theme").off("click").on("click",function(g){var f=$(this),h=$(".mind-theme-dlg");mindUI.showMenu(f,h)});$("#offline_btn").off("click").on("click",function(g){if(mindColla.collaUserCount>1){$.showTip("多人协作时，禁止使用离线编辑功能",2500);return}var f=$(this),h=$(".mind-offline-dlg");h.show().css({opacity:1,top:50});setTimeout(function(){h.css("opacity","0.5")},2500);f.hide();f.next().show();mindColla.offlineModel=true;mind.messageSource.saveLocal(mind);mindColla.stop(false)});$("#offline_save_btn").off("click").on("click",function(g){var f=$(this),h=$(".mind-offline-dlg");h.css({opacity:1});$(".mind-offline-dlg .closeoff").prev().text("保存中...");mindColla.doSync(chartId,function(){$(".mind-offline-dlg .closeoff").prev().text("保存成功");setTimeout(function(){$(".mind-offline-dlg .closeoff").prev().text("已进入离线模式");h.css("opacity",".2")},1000)})});$(".mind-offline-dlg .closeoff").off("click").on("click",function(g){var f=$(this),h=$(".mind-offline-dlg");f.prev().text("已退出，保存中...");mindColla.doSync(chartId,function(){$(".mind-offline-dlg .closeoff").prev().text("保存成功");mindUI.removeFile(chartId);mindColla.collaStart();mindColla.offlineModel=false;setTimeout(function(){$("#btnoffline").children().eq(0).show();$("#btnoffline").children().eq(1).hide();$(".mind-offline-dlg .closeoff").prev().text("已进入离线模式");h.css("opacity","0");h.hide()},1500)})});window.onbeforeunload=function(f){if(mindColla.offlineModel){mindColla.doSync(chartId);return"当前处于离线模式，退出前请保存"}mindColla.stop(false)};var d="";$(".header-item .title").off("focus").on("focus",function(g){var f=$(this);f.select();d=f.val();g.stopPropagation()});$(".header-item .title").off("keydown").on("keydown",function(g){if(g.keyCode==13){var f=$(this),h=$.trim(f.val());if(h!=""){mindUI.saveTitle(h)}f.removeAttr("contenteditable");g.preventDefault()}});$(".header-item .title").off("blur").on("blur",function(g){g.stopPropagation();var f=$(this),h=$.trim(f.val());if(h!=""){mindUI.saveTitle(h)}f.removeAttr("contenteditable")});$("#newFile").off("click").on("click",function(){mindUI.createNew()});$(".header-item.undo").off("click").on("click",function(){var f=mind;f.messageSource.undo(f)});$(".header-item.redo").off("click").on("click",function(){var f=mind;f.messageSource.redo(f)});$(".header-item.brash").off("click").on("click",function(){var f=mind;f.operation.initBrash(f)});$("#btnsave").off("click").on("click",function(){$.mask();mindUI.saveOnline()});$("#btndownload").off("click").on("click",function(){var f=$(".mind-download-dlg");$.mask();f.show();setTimeout(function(){$("#btn-download").removeClass("mind-disable")},500)});$("#btn-download-cancel").on("click",function(){var f=$(".mind-download-dlg");f.hide();$.mask("close")});$("#btn-download").on("click",function(){var f=$(".mind-download-dlg");var g=$("input[type=radio][name=downas]").val();$("#export_title").val($(".header-item > .title:first").text());$("#export_definition").val(JSON.stringify(mind.model.topic));$("#export_form").submit();f.hide();setTimeout(function(){$.mask("close");$("#btn-download").addClass("mind-disable")},800)});$("#btnview").on("click",function(){var g=$(this),h=$(".mind-slider-dlg"),f=mind.plugins.presenter;mind.opts.readonly=true;mindUI.showMenu(g,h);f.renderSelections();f.beforeSelecting=true;$(".mind-dock-right").hide();$(".mind-share-network").hide();$("#startpre").off().on("click",function(){f.ready(mind);f.toSlide(mind,0);$.showTip("close");$.showTip("← → 键切换，ESC退出",2500)});$(".mind-slider-close").on("click",function(){$(".mind-dock-right").show();$("header").show();$(".mind-share-network").show();$(".mind-slider-dlg").hide();f.beforeSelecting=false;$(".mind-slide-selection").remove();mind.opts.readonly=false;$(".mind-slide-disable").removeClass("mind-slide-disable");var i=$("g").children("path");i.removeAttr("style");$(".mind-slide-controls").remove()})});$(".mind-zoomin").off().on("click",function(){mind.operation.zoomIn(mind.designer);var f=mind.operation.zoomVal;$(".mind-zoomtxt").text(f)});$(".mind-zoomout").off().on("click",function(){mind.operation.zoomOut(mind.designer);var f=mind.operation.zoomVal;$(".mind-zoomtxt").text(f)});$("#mind-theme-customise").on("click",function(){var f=$(".mind-theme-customise-dlg");f.show();$.mask();var g=mind.style.themes.theme3;$(".mind-theme-dlg").hide().css("opacity",0);mindUI.initCustomise(g)});$("#btn-customise-close").on("click",function(){var f=$(".mind-theme-customise-dlg");f.hide();$.mask("close")});$("#btn-customise-save").on("click",function(){var l=mindUI.customiseTheme;if(l!=null){var f=sessionStorage.getItem("customiseThemes");var g=JSON.parse(f)||[];if(mindUI.editCustomiseId!=null){var k=0;for(var h=0;h<g.length;h++){var j=g[h];if(j.id==mindUI.editCustomiseId){k=h;break}}g.splice(k,k,l);sessionStorage.setItem("customiseThemes",JSON.stringify(g));mindUI.saveTheme(l,function(){var i=$(".mind-theme-customise-dlg");i.hide();$.mask("close");mind.style.setTheme.call(mind,l.id);mindUI.customiseTheme=null});return}var m=mindUI.newId();l.id="customise_"+m;if(g.length>=5){$.showTip("最多只能自定义五种风格",1000);return}g.push(l);sessionStorage.setItem("customiseThemes",JSON.stringify(g));mindUI.saveTheme(l,function(){var i=$(".mind-theme-customise-dlg");i.hide();$.mask("close");mind.style.setTheme.call(mind,l.id);mindUI.customiseTheme=null})}});$(".mind-help").on("click",function(){var f=$("#helpcenter-dlg"),g=$(this);if(f.css("opacity")==0){f.show().css({opacity:1,right:60})}else{f.show().css({opacity:0,right:-200})}$("#sharecenter-dlg").hide();$(document).on("mouseup.closeme",function(){f.show().css({opacity:0,right:-200})});f.on("mouseup.closeme",function(h){h.stopPropagation()})});$("#btn_shortkey").on("mousedown",function(g){var f=$(".mind-shortkey-dlg");f.show();$.mask();g.stopPropagation()});$("#shortkey_dlg_cancel").on("click",function(){var f=$(".mind-shortkey-dlg");f.hide();$.mask("close")});$("#callback_dlg_cancel").on("click",function(){var f=$(".mind-callback-dlg");f.hide();$.mask("close")});$("#callback_dlg_save").on("click",function(){var f=$(this);f.addClass("mind-disable");mindUI.saveFeedBack(function(){var g=$(".mind-callback-dlg");g.hide();$.mask("close");$.showTip("你的反馈已提交",1000);f.removeClass("mind-disable")})});$("#btn_callback").on("mousedown",function(g){var f=$(".mind-callback-dlg");f.show();f.find("textarea").focus();$.mask();g.stopPropagation()});$("#btn-share-network").on("click",function(){var f=$(".mind-dock-right-con"),g=$(".mind-dock-right");var h=$(".mind-dock-right-close");if(h.length){f.css({right:-315,opacity:0});h.remove();g.find(".selected").removeClass("selected")}f=$("#sharecenter-dlg").show();if(f.css("opacity")==0){f.css({opacity:1,right:60})}else{f.css({opacity:0,right:-200})}$("#helpcenter-dlg").hide();$(document).on("mouseup.closeme",function(){f.show().css({opacity:0,right:-200})});f.on("mouseup.closeme",function(i){i.stopPropagation()})});$("#btn_pubpo").on("mousedown",function(g){var f=$("#mind-publish-dlg");f.show();$.mask();f.find(".mind-dlg-content").html(mindShare.publish.source);mindShare.publish.execute(chartId);g.stopPropagation()});$("#btn_shareGroup").on("mousedown",function(j){var f=$(".mind-share-dlg");f.show();$.mask();var i=f.find(".mind-dialog-left"),g=f.find(".mind-dialog-right"),h=f.outerWidth();i.find("li").off("click").on("click",function(){var k=$(this).attr("tit");$(this).addClass("active").siblings().removeClass("active");g.empty();g.html(mindShare[k].source);mindShare[k].execute(chartId)});i.find("li:eq(0)").trigger("click");j.stopPropagation()});$(".mind-dock-colla").on("click",function(){var f=$("#colla_add");f.show();$.mask();mindShare.collaboration.init(chartId,"chart")});$("#btn-history-add").on("click",function(){var f=$("#area-history-add"),g=$(this);f.show();g.hide();f.find("textarea").focus();$(".mind-dock-right-con").scrollTop(2000)});$("#btn-histoty-add-cancel").on("click",function(){var f=$("#area-history-add"),g=$("#btn-history-add");f.hide();g.show();f.find("textarea").val("")});$("#btn-histoty-save").on("click",function(){var f=$("#area-history-add"),h=$("#btn-history-add"),g=$(this);g.addClass("mind-disable");mindUI.addHistory(function(){f.hide();h.show();f.find("textarea").val("")})});$("#btn-history-restore").on("click",function(){var f=$(this);mindUI.restoreHistory(function(){f.addClass("mind-disable").removeClass("active");mindUI.loadHistorys()})});$("#remove-link").on("click",function(){$("#mind-topic-link").val("");$("#mind-topic-linktitle").val("");mind.operation.removeLink.call(mind)});$("#remove-task").on("click",function(){mind.task.removeTask.call(mind);$("#mind-task-assigned").val("");$(".mind-dock-right-task").find(".mind-select-box").text("无")});$(".mind-dock-right").children().off("click").on("click",function(m){var h=mind.util.getSelectedId();if(h==""){$.showTip("请先选中一个主题",1000);return}var j=$(".mind-dock-right-close");var n=mind.model.getTopicById(h);var i=$(".mind-dock-right-con"),p=$(".mind-dock-right"),k=$(this),g=k.attr("tit");if(k.find("a").hasClass("selected")){i.css({right:-290,opacity:0});j.remove();k.find("a").removeClass("selected");return}var j=$(".mind-dock-right-close");var n=mind.model.getTopicById(h);var i=$(".mind-dock-right-con"),p=$(".mind-dock-right"),k=$(this),g=k.attr("tit");if(k.find("a").hasClass("selected")){i.css({right:-290,opacity:0});j.remove();k.find("a").removeClass("selected");return}mindUI.initDock(n);p.find(".selected").removeClass("selected");k.find("a").addClass("selected");var o=$(window).width()-p.offset().left;i.css({right:o,opacity:".9",left:"none"});if(j.length==0){j=$("<span class='mind-dock-right-close mind-icons'>&#xe668;</span>").appendTo("body");j.on("click",function(q){i.css({right:-290,opacity:0});j.remove();p.find(".selected").removeClass("selected");q.stopPropagation()});j.css({top:i.offset().top+10,right:o+i.width()-20}).show();setTimeout(function(){j.css({right:o+i.width(),opacity:1})},250)}var f=i.find("#"+g),l=f.find("h3");i.children().find("h3").removeClass("active");l.addClass("active");f.show().siblings().hide()});$("#mind-select-font").on("click",function(){var f=$(this);$("#mind-font-list").dropdown({target:f,onSelect:function(h){var g=h.text();f.children("span").text(g);mind.operation.setStyle.call(mind,{"font-family":g});f.removeClass("selected")},onClose:function(){f.removeClass("selected")}});f.addClass("selected")});$("#mind-font-b").on("click",function(){var h=$(this),g=h.children("label"),f=h.hasClass("selected");if(f){h.removeClass("selected");mind.operation.setStyle.call(mind,{"font-weight":"normal"})}else{h.addClass("selected");mind.operation.setStyle.call(mind,{"font-weight":"bold"})}});$("#mind-font-i").on("click",function(){var h=$(this),g=h.children("label"),f=h.hasClass("selected");if(f){h.removeClass("selected");mind.operation.setStyle.call(mind,{"font-style":"normal"})}else{h.addClass("selected");mind.operation.setStyle.call(mind,{"font-style":"italic"})}});$("#mind-font-left").on("click",function(){var f=$(this);mind.operation.setStyle.call(mind,{"text-align":"left"});f.addClass("selected");f.siblings("[align]").removeClass("selected")});$("#mind-font-center").on("click",function(){var f=$(this);mind.operation.setStyle.call(mind,{"text-align":"center"});f.addClass("selected");f.siblings("[align]").removeClass("selected")});$("#mind-font-right").on("click",function(){var f=$(this);mind.operation.setStyle.call(mind,{"text-align":"right"});f.addClass("selected");f.siblings("[align]").removeClass("selected")});$("#mind-customise-bc_").off().on("click",function(){var h=$(this);var h=$(this),f=h.css("color");var g=mind.util.getHexColor(f);$.colorpicker({target:h,setColor:f,onSelect:function(i){if(i==null){i="transparent"}else{i="#"+i}h.css("color",i);mind.operation.setStyle.call(mind,{"border-color":i});h.removeClass("selected")},onClose:function(){h.removeClass("selected")}});$("#color-hex-value").val(g.hex);h.addClass("selected")});$("#mind-customise-bw_").off().on("click",function(){var f=$(this);$("#mind-customise-borderw").dropdown({target:f,onSelect:function(h){var i=h.attr("tp");var g=h.text();f.children("span").text(g);mind.operation.setStyle.call(mind,{"border-width":i});f.removeClass("selected")},onClose:function(){f.removeClass("selected")}});f.addClass("selected")});$("#mind-customise-bst_").off().on("click",function(){var f=$(this);$("#mind-customise-borderst").dropdown({target:f,onSelect:function(i){var g=i.text();f.children("span").text(g);var h=i.attr("tp");mind.operation.setStyle.call(mind,{"border-style":h});f.removeClass("selected")},onClose:function(){f.removeClass("selected")}});f.addClass("selected")});$("#mind-customise-bs1_").on("click",function(){var f=$(this);mind.operation.setStyle.call(mind,{"border-radius":"0px"});f.addClass("selected");f.siblings().removeClass("selected")});$("#mind-customise-bs2_").on("click",function(){var f=$(this);mind.operation.setStyle.call(mind,{"border-radius":"5px"});f.addClass("selected");f.siblings().removeClass("selected")});$("#mind-customise-bs3_").on("click",function(){var f=$(this);mind.operation.setStyle.call(mind,{"border-radius":"30px"});f.addClass("selected");f.siblings().removeClass("selected")});$("#mind-customise-linec_").off().on("click",function(){var h=$(this);var h=$(this),f=h.css("color");var g=mind.util.getHexColor(f);$.colorpicker({target:h,setColor:f,onSelect:function(i){if(i==null){i="transparent"}else{i="#"+i}h.css("color",i);mind.operation.setStyle.call(mind,{"line-color":i});h.removeClass("selected")},onClose:function(){h.removeClass("selected")}});$("#color-hex-value").val(g.hex);h.addClass("selected")});$("#mind-customise-linet_").off().on("click",function(){var f=$(this);$("#mind-customise-linet-list_").css("z-index",10).dropdown({target:f,onSelect:function(h){var g=h.attr("tp"),i=h.text();f.children("span").text(i);mind.operation.setStyle.call(mind,{"line-type":g});f.removeClass("selected")},onClose:function(){f.removeClass("selected")}})});$("#mind-customise-linew_").off().on("click",function(){var f=$(this);$("#mind-customise-linew-list").css("z-index",10).dropdown({target:f,onSelect:function(g){var h=g.attr("tp");f.children("span").text(h+"px");mind.operation.setStyle.call(mind,{"line-width":h})},onClose:function(){f.removeClass("selected")}})});$("#mind-topic-bg").on("click",function(){var h=$(this),f=h.css("background-color");var g=mind.util.getHexColor(f);$.colorpicker({target:h,setColor:f,onSelect:function(i){if(i==null){var j=mind.designer.css("background-color");h.css("background-color",j);mind.operation.setStyle.call(mind,{"background-color":j})}else{i="#"+i;h.css("background-color",i);mind.operation.setStyle.call(mind,{"background-color":i})}h.removeClass("selected")},onClose:function(){h.removeClass("selected")}});$("#color-hex-value").val(g.hex);h.addClass("selected")});$("#mind-canvas-bg").on("click",function(){var g=$(this),f=g.css("background");$.colorpicker({target:g,setColor:f,onSelect:function(h){h="#"+h;g.find(".mind-icons").css("color",h);mind.operation.setBackground.call(mind,h,true);g.removeClass("selected")},onClose:function(){g.removeClass("selected")}});g.addClass("selected")});$("#mind-font-color").on("click",function(){var g=$(this),f=g.css("color");$.colorpicker({target:g,setColor:f,onSelect:function(h){h="#"+h;g.css("color",h);mind.operation.setStyle.call(mind,{color:h});g.removeClass("selected")},onClose:function(){g.removeClass("selected")}});g.addClass("selected")});$("#mind-number-size").numberBox({callback:function(f){mind.operation.setStyle.call(mind,{"font-size":f})}});$("#mind-task-priority").on("click",function(){var f=$(this);$("#mind-icons-priority-list").dropdown({target:f,position:"right",width:80,onSelect:function(l){var m=l.clone();m.find("span").remove();var i=m.text(),j=m.attr("priority"),k=m.attr("ico");var h=l.find(".mind-icons").css("color");var g=$("#mind-dock-right-icons").find("[ico="+k+"]");if(j==null){mind.icons.removeIcon.call(mind,"priority")}else{mind.icons.setIcon.call(mind,g,{priority:j},h)}f.children("span").text(i);f.removeClass("selected");m.remove()},onClose:function(){f.removeClass("selected")}});f.addClass("selected")});$("#mind-task-completion").on("click",function(){var f=$(this);$("#mind-icons-completion-list").dropdown({target:f,position:"right",width:80,onSelect:function(l){var m=l.clone();m.find("span").remove();var j=m.text(),i=m.attr("completion"),k=m.attr("ico");var h=l.find(".mind-icons").css("color");f.children("span").text(j);var g=$("#mind-dock-right-icons").find("[ico="+k+"]");if(i==null){mind.icons.removeIcon.call(mind,"completion")}else{mind.icons.setIcon.call(mind,g,{completion:i},h)}f.removeClass("selected");m.remove()},onClose:function(){f.removeClass("selected")}});f.addClass("selected")});$("#mind-task-end").off("click").on("click",function(g){var f=$(this);$("#mind-task-end").datePicker({dateFormat:"yyyy-MM-dd",selected:function(h){f.find("span").text(h);mind.task.setTask.call(mind,{end:h})}});g.stopPropagation()});$("#mind-task-start").off("click").on("click",function(g){var f=$(this);$("#mind-task-start").datePicker({dateFormat:"yyyy-MM-dd",selected:function(h){f.find("span").text(h);mind.task.setTask.call(mind,{start:h})}});g.stopPropagation()});$("#mind-task-assigned").on("blur",function(){var f=$(this),g=$.trim(f.val());if(g!=""&&g.length<20){mind.task.setTask.call(mind,{assigned:g})}else{if(g==""){mind.task.setTask.call(mind,{assigned:null})}}});$(document).on("mousedown.titlemenu",".header-item .title,.mind-title-menu,.mind-theme-dlg,.mind-image-dlg,.header-item.icon.down,.header-item.icon.theme,.header-item.icon.image",function(f){f.stopPropagation()});$(document).on("mousedown.titlemenu",function(h){var i=$(".mind-title-menu"),g=$(".mind-theme-dlg"),f=$(".mind-image-dlg");mindUI.closeMenu(i);mindUI.closeMenu(g);mindUI.closeMenu(f)});$(".header-item.icon.icon_conn").on("click",function(g){var f=mind.util.getSelectedId();if(f==""){$.showTip("请先选中一个主题",1000);return}mind.connection.render.call(mind,g)});$(".header-item.icon.image").on("click",function(g){var f=$(this),h=$(".mind-image-dlg");mindUI.showMenu(f,h,function(){$("#text-insert-img").val("");$(".mind-tab a[tit]").off().on("click",function(){$(".mind-tab a[tit]").removeClass("active");var s=$(this),p=$(".mind-tab-con"),q=p.children().eq(0),o=p.children().eq(1);s.addClass("active");var r=s.attr("tit"),t=p.children("[tit="+r+"]");t.fadeIn(250);t.siblings().hide();if(s.attr("tit")=="upload"){$(".mind-tab-con").css({height:160})}else{if(s.attr("tit")=="online"){$(".mind-tab-con").css({height:"60px"});$("#text-insert-img").focus()}else{if(s.attr("tit")=="search"){$(".mind-tab-con").css({height:"300px"});$("#text-search-img").focus()}}}});$("#btn-insert-img").off().on("click",function(){var q=$("#text-insert-img");var o=/(http[s]?:\/\/.*\.(png|jpg|gif|svg|jpeg)$)/i;if($.trim(q.val())==""){q.focus();return}else{if(!o.test(q.val())){q.select();return}else{var p=new Image();p.src=q.val();p.onload=function(){mind.operation.setTopicImage.call(mind,null,q.val(),p)}}}});var i=false,l=0,m="";$("#text-search-img").off().on("keyup",function(p){var o=$(this);if($.trim(o.val())==""){return}if(!i){i=true;$("#search-img-loading").show();m=o.val();l=0;k()}});function k(){if(m==""){return}j(function(o){if(o!=null){var p=o.data;n(p)}})}function j(o){$.ajax({type:"get",async:false,url:"https://image.baidu.com/search/acjson?tn=resultjson_com&ipn=rj&fp=result&ie=utf-8&oe=utf-8&pn="+l+"&rn=9&word="+m,dataType:"jsonp",jsonp:"callback",jsonpCallback:"flightHandler",success:function(p){if(o!=null){o(p)}}})}function n(u){var p=$("#search-img-con");p.empty();var q="";for(var t=0,o=u.length;t<o;t++){var r=u[t];if(r==null||r.thumbURL==null){continue}q+='<img msrc="'+(r.hoverURL||r.middleURL)+'" alt="" src="'+r.thumbURL+'" />'}var s="<div class='page-btn'><span class='mind-icons'>&#xe66a;</span><span class='mind-icons'>&#xe66b;</span></div>";p.html(q+s);i=false;$("#search-img-loading").hide();p.children("img").off().on("click",function(){var v=$(this).attr("msrc");var w=new Image();w.src=v;w.onload=function(){mind.operation.setTopicImage.call(mind,null,v,w)}});$(".page-btn").children().off().on("click",function(w){var v=$(this);if(v.index()>0){l+=9}else{l-=9;if(l<0){l=0}}k()})}})});$(document).on("keydown.hotkey",".mind-image-dlg",function(f){f.stopPropagation()});$("input[name=mind_upload_img_file]").off("change").on("change",function(g){var f=this.files[0].type;if($.trim($(this).val())==""){return}if(f.indexOf("image")>=0){mindUI.showUploading();$("#upload_mind_img").submitForm({success:function(h){if(h.result=="size_wrong"){$.loading("close");$.showTip("图片大小不能超过2M",2500);mindUI.hideUploading();return}if(h.result=="type_wrong"){$.loading("close");$.showTip("只能上传图片",2500);mindUI.hideUploading();return}if(h.img_url!=""){var i=new Image();i.src=h.img_url;i.onload=function(){mind.operation.setTopicImage.call(mind,null,h.img_url,i);mindUI.hideUploading()}}},error:function(){$.loading("close")}})}else{}});var c=document.getElementById("upload-con");c.addEventListener("dragover",function(f){c.style.border="2px dashed #888";f.preventDefault();f.stopPropagation()});c.addEventListener("drop",function(h){c.style.border="2px dashed #ddd";h.preventDefault();h.stopPropagation();var g=h.dataTransfer.files[0];if(g.type.indexOf("image")<0){return}var f=Math.floor((g.size)/1024);if(f>3072){return}$("#upload_mind_img").submitForm({success:function(i){if(i.img_url!=""){var j=new Image();j.src=i.img_url;j.onload=function(){mind.operation.setTopicImage.call(mind,null,i.img_url,j)}}},error:function(){}})});var b=null;$("#mind-topic-remack").on("blur",function(f){var g=$(this).val();mind.remark.setRemark.call(mind,g,b)});$("#mind-topic-remack").on("focus",function(f){b=mind.util.getSelectedId()});$("#mind-topic-tag").on("blur",function(g){var h=$(this).val();h=mind.util.htmlEncode(h);if($.trim(h)!=""){var f=$(this);a(f)}});$("#mind-topic-link").on("blur",function(g){var f=$(this);e(f)});$("#mind-topic-linktitle").on("blur",function(g){var f=$("#mind-topic-link");e(f)});$("#mind-dock-right-icons").find(".mind-icons").on("click",function(g){var h=$(this);if(h.attr("remove")){mind.icons.removeIcon.call(mind)}else{var i=h.attr("n");var f=null;if(i=="flag"){f=h.css("color")}mind.icons.setIcon.call(mind,h,null,f)}});$("#mind-topic-tag").on("keyup",function(g){if(g.keyCode==13){var f=$(this);a(f)}});function e(h){var i=$.trim(h.val());if(i!=""&&mind.util.isUrl(i)){var f=$.trim($("#mind-topic-linktitle").val());var g={value:i,title:f,type:"url"};mind.operation.setLink.call(mind,g)}else{if(i!=""){h.select()}}}function a(j){var g=$("#mind-topic-tags");var l=$.trim(j.val());if(l==""||l.length>20){return}var i=g.children().map(function(n,m){return $(this).text()}).get();if(i.indexOf(l)>=0){j.val("");return}var f=$("<span></span>");g.append(f);f.text(l);var h={color:"#276F86",background:"#d6f0f8"};f.css({background:h.background,color:h.color});f.append(" <label class='mind-icons'>&#xe622;</label>");var k={text:l,color:h.color,background:h.background};mind.tags.setTags.call(mind,k);j.val("");mindUI.initTagsEvents()}setTimeout(function(){mindUI.loadHistorys()},1000);setTimeout(function(){mindUI.loadRecentFiles();mindUI.loadThemes(mind)},1500);setTimeout(function(){mindColla.getSliders()},600);mindColla.collaStart();mindUI.initStructure()});var mindColla={offlineModel:false,isChecking:false,isOffLine:false,isSending:false,mess:[],tempMess:[],send:function(d){$("#savetip").text("正在保存...");if(mindColla.isOffLine||mindColla.offlineModel){mind.messageSource.saveLocal(mind);if(mindColla.offlineModel){return}mindColla.checkNetwork();return}if(this.isSending){this.tempMess=this.tempMess.concat(d);return}mindColla.collaCount=0;var c=this.collaUk;var a=this.collaClient;this.mess=this.tempMess.concat(d);this.isSending=true;this.tempMess=[];var b=JSON.stringify(this.mess);$.ajax({url:"/mindmap/msg",data:{msgStr:b,ignore:"msgStr",chartId:chartId,uk:c,client:a},cache:false,type:"post",timeout:10000,success:function(e){if(e.error){mindColla.isOffLine=true;mindColla.showTip()}else{setTimeout(function(){$("#savetip").text("所有更改已保存")},100)}mindColla.isSending=false;mindColla.mess=[]},error:function(f){if(mindColla.collaUserCount>1){mindColla.stop();return}mindColla.isOffLine=true;mindColla.showTip();mindColla.isSending=false;mindColla.mess=[];mindUI.addHistory()}})},checkNetwork:function(){$.ajax({url:"/mindmap/checknetwork",success:function(a){if(a.result=="success"){$("#savetip").text("正在保存...");mindColla.doSync(chartId,function(){mindColla.closeTip();mindColla.isOffLine=false})}},error:function(a){}})},saveCount:1,doSync:function(c,b){var a=mindUI.getFile(c);if(a!=null){$.ajax({url:"/mindmap/saveonline",type:"post",cache:false,data:{id:c,def:a,shapecount:a.split('"children":[').length,ignore:"def"},success:function(d){if(d.result=="success"){b()}else{if(d.error=="error"){$(".mind-offline-dlg .closeoff").prev().text("网络未连接");setTimeout(function(){$(".mind-offline-dlg .closeoff").prev().text("已进入离线模式")},1500)}}},error:function(d){}})}},showOffline:function(){},showTip:function(){$("#offline_btn").trigger("click")},closeTip:function(){var a=$("#mind-error-tip");a.fadeOut(function(){a.remove()})},saveSliders:function(a){$.ajax({url:"/mindmap/savesliders",type:"post",data:{id:mindUI.chartId(),def:JSON.stringify(a),ignore:"def"},success:function(b){}})},getSliders:function(){$.ajax({url:"/mindmap/getsliders",data:{id:mindUI.chartId()},success:function(a){if(a.slider!=null){mind.plugins.presenter.sliders=JSON.parse(a.slider.def)}}})},collaClient:null,collaUk:null,collaItv:null,collaUsers:{},baseUrl:"https://cb.processon.com/",collaStart:function(){var c=sessionStorage.getItem("mindclient_"+chartId);var b=mindColla,a="";if(c==null){a=new Date().valueOf();sessionStorage.setItem("mindclient_"+chartId,a)}else{a=c}$.ajax({url:"/mindmap/listen",type:"post",data:{subject:chartId,client:a},success:function(h){var g=[];var f=h.users;for(var e=0;e<f.length;e++){var d=f[e];if(g.indexOf(d.userId)<0){g.push(d.userId)}}mindColla.collaClient=a;mindColla.collaUk=h.uk;mindColla.collaItv=null;mindColla.collaItv=window.setInterval(mindColla.poll,mindColla.collaPollTime);mindColla.collaUserCount=f.length},error:function(){}})},collaCount:0,collaPollTime:3000,collaUserCount:1,poll:function(){mindColla.collaCount++;if(mindColla.collaCount>3600){mindColla.stop();return}var a=mindColla.collaClient,b=mindColla.collaUk;$.ajax({url:mindColla.baseUrl+"mindmap/poll",type:"get",cache:false,data:{subject:chartId,client:a,uk:b},success:function(g){var h=g.users;if(h==null){return}if(h.length!=mindColla.collaUserCount){mindColla.collaUserCount=h.length}mindColla.renderUsers(h);var f=g.msgs;for(var e=0;e<f.length;e++){var c=JSON.parse(f[e]);if(c.client==a){continue}try{mind.messageSource.excuteMsgDirect.call(mind,c,function(j,i){mindColla.showUserOp(j,i)})}catch(d){continue}}},error:function(){}})},renderUsers:function(b){var j=this;var c=$("#colla-users-con");if(c.length==0&&b.length>1){c=$("<div id='colla-users-con'><div class='colla-tip'><span></span></div></div>").appendTo(".mind-util-container")}else{if(b.length==0){if(c.length>0){c.remove()}return}}if(mindColla.offlineModel&&b.length>1){mindColla.stop();return}j.collaUsers={};var h=[];for(var g=0;g<b.length;g++){var f=b[g];if(h.indexOf(f.userId)>=0){continue}h.push(f.userId);j.collaUsers[f.userId]=f}var k=[],l=[],m;c.children().each(function(n,o){var p=o.getAttribute("uid");if(h.indexOf(p)<0&&p){k.push(p)}});for(var g=0;g<h.length;g++){var a=h[g];var e=c.find(".colla-user[uid="+a+"]");if(e.length==0){l.push(a)}}var d="";if(k.length>0){j.showCollaTip(c,k,"leave")}if(l.length>0){j.showCollaTip(c,l,"join")}},userOpCount:{},showUserOp:function(d,c){var b=mindColla.collaUsers[c];if(b==null){return}if(d.length==0){return}var g=d[0];var f=$("#"+g);if(f!=null){var e=f.offset();var a=$(".colla-user-tip-con[uk="+c+"]");if(a.length==0){a=$("<div uk='"+c+"' class='colla-user-tip-con'><img src='https://processon.io/photo/"+b.userId+".png'/> <span>"+b.name+"</span>正在编辑</div>").appendTo("body");if(mindColla.userOpCount[c]!=null){window.clearTimeout(mindColla.userOpCount[c])}mindColla.userOpCount[c]=setTimeout(function(){a.fadeOut().remove()},2000)}a.css({left:e.left+f.outerWidth()+12,top:e.top+f.outerHeight()/2-a.outerHeight()/2}).show()}},stm:null,showCollaTip:function(c,a,l){var k=this,e="",h="",d=[];var j=(l=="leave")?"离开":"加入";for(var g=0;g<a.length;g++){var b=a[g];var f=k.collaUsers[b];if(l=="join"){if(d.indexOf(f.userId)<0){h="<div uid='"+b+"' class='colla-user' title_pos='top' title='"+f.name+"'><a target='_blank' href='/u/"+f.uname+"/profile'><img src='https://www.processon.io/photo/"+f.userId+".png'/></a></div>";c.append(h);d.push(f.userId)}}else{c.find("[uid="+b+"]").remove()}if(f==null||f.client==mindColla.collaClient){continue}if(e!=""){e+=","}e+=f.name}if(e!=""){c.find(".colla-tip").children("span").text(e+j+" 了协作");c.find(".colla-tip").css("left","100%").show();window.clearTimeout(k.stm);k.stm=setTimeout(function(){c.find(".colla-tip").hide()},3000)}},stop:function(c){var a=mindColla.collaClient,b=mindColla.collaUk;window.clearInterval(mindColla.collaItv);if(c==null){mindColla.renderOff()}$.ajax({url:"/mindmap/stop",type:"post",async:false,cache:false,data:{subject:chartId,client:a,uk:b},success:function(d){},error:function(){}})},renderOff:function(){if($("#stop_listen_tip").length){return}var a='<div id="stop_listen_tip"><div style="font-size:17px;margin-top:40px;color:#999;font-size:16px;"><span style="font-size:20px;" class="mind-icons">&#xe663;</span> 温馨提示</div><div style="font-size:16px;margin-top:58px;color:#666;">由于您长时间未编辑脑图<br><br>系统已自动为您存储历史版本并暂停了作图</div><div style="color:#666;font-size:16px;margin-top:40px;">点击 <a style="color:#63abf7;cursor:pointer" onclick="location.reload();">恢复</a></div></div>';if(mindColla.offlineModel){a='<div id="stop_listen_tip"><div style="font-size:17px;margin-top:40px;color:#999;font-size:16px;"><span style="font-size:20px;" class="mind-icons">&#xe663;</span> 温馨提示</div><div style="font-size:16px;margin-top:58px;color:#666;">使用离线编辑功能时，不能与其他用户实时协作</div><div style="font-size:16px;margin-top:8px;color:#666;">当前编辑状态已经为您存储历史版本</div><div style="color:#666;font-size:16px;margin-top:40px;">点击 <a style="color:#63abf7;cursor:pointer" onclick="location.reload();">刷新页面</a></div></div>'}$(a).appendTo("body").show();$.mask()}};var mindUI={chartId:function(){return chartId},newId:function(){return(this.newIdS4()+this.newIdS4()+this.newIdS4())},newIdS4:function(){return(((1+Math.random())*65536)|0).toString(16).substring(1)},saveTamp:0,getRandomColor:function(){var b=["rgb(255, 244, 179)","rgb(179, 229, 255)","rgb(196, 179, 255)","rgb(236, 255, 179)","rgb(216, 210, 210)"];var a=parseInt(Math.random()*5);return b[a]},filterXss:function(a){if(a==null||a==""){return""}a=a.toString();a=a.replace(/</g,"&lt;");a=a.replace(/%3C/g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/%3E/g,"&gt;");a=a.replace(/'/g,"&#39;");a=a.replace(/"/g,"&quot;");return a},restoreXss:function(a){if(a==null||a==""){return""}a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&#39;/g,"'");a=a.replace(/&quot;/g,'"');return a},initDock:function(r){var p=mind.model.topic;if(!r.root){$(".brash").removeClass("mind-disable")}var w=mind.style.getStyle.call(mind,r);var f,o,H,x,s,l,L,k;k=p.background||mind.styles.background;if(r.style!=null){var G=r.style;o=G["font-size"];f=G["font-family"];H=G.color;x=G["font-weight"];s=G["font-style"];l=G["text-align"];L=G["background-color"]}if((x||w["font-weight"])=="bold"){$("#mind-font-b").addClass("selected")}else{$("#mind-font-b").removeClass("selected")}if((s||w["font-style"])=="italic"){$("#mind-font-i").addClass("selected")}else{$("#mind-font-i").removeClass("selected")}var h=w["border-width"],I=w.border;if(h!=null||I){var E=$("#"+r.id);var B=E.css("border-width");var D=E.css("border-style");var N=E.css("border-color");$("#mind-customise-bw_").children("span").text(B);var q=$("#mind-customise-borderst").children("[tp="+D+"]").text();$("#mind-customise-bst_").children("span").text(q);$("#mind-customise-bc_").children("label").css("color",N)}var a=w["border-radius"];if(a!=null){a=parseInt(a);if(a==5){$("#mind-customise-bs2_").addClass("selected").siblings().removeClass("selected")}else{if(a==0){$("#mind-customise-bs1_").addClass("selected").siblings().removeClass("selected")}else{if(a==30){$("#mind-customise-bs3_").addClass("selected").siblings().removeClass("selected")}}}}$("#mind-select-font").children("span").text(f||w["font-family"]);$("#mind-number-size").children("input").val(o==null?w["font-size"]:(o+"px"));$("#mind-font-color").css("color",H||w.color);if((l||w["text-align"])=="left"){$("#mind-font-align").children("label").html("&#xe60a;")}else{if((l||w["text-align"])=="center"){$("#mind-font-align").children("label").html("&#xe643;")}else{$("#mind-font-align").children("label").html("&#xe60b;")}}if(L!=null||w.backgroundColor!=null){$("#mind-topic-bg").css({"background-color":L||w.backgroundColor,color:H||w.color})}else{$("#mind-topic-bg").css({"background-color":"#fff",color:"#333"})}$("#mind-canvas-bg").find(".mind-icons").css("color",k);var K=r.icons;if(K){var z=$("#mind-dock-right-icons");z.find(".selected").removeClass("selected");for(var J=0,m=K.length;J<m;J++){var g=K[J];z.find(".mind-icons[ico="+g.index+"]").addClass("selected")}}else{$("#mind-dock-right-icons").find(".selected").removeClass("selected")}var n=r.note,v=r.tags,d=r.link,A=r.task;if(n){var b=mindUI.restoreXss(n);$("#mind-topic-remack").val(b)}else{$("#mind-topic-remack").val("")}if(v){var e=$("#mind-topic-tags"),t="";for(var J=0,m=v.length;J<m;J++){var F=v[J];t+="<span style='color:"+F.color+";background:"+F.background+"'>"+F.text+" <label class='mind-icons'>&#xe622;</label></span>"}e.html(t)}else{$("#mind-topic-tags").html("")}if(d){$("#mind-topic-link").val(d.value);$("#mind-topic-linktitle").val(d.title)}else{$("#mind-topic-link").val("");$("#mind-topic-linktitle").val("")}if(A){var C=$("#mind-icons-priority-list"),c=$("#mind-icons-completion-list");var u=C.find("li[priority="+A.priority+"]").clone(),y=c.find("li[completion="+A.completion+"]").clone();u.find("span").remove();y.find("span").remove();var j=u.text();var M=y.text();if(j!=""){$("#mind-task-priority").children("span").text(j)}else{$("#mind-task-priority").children("span").text("无")}if(M!=""){$("#mind-task-completion").children("span").text(M)}else{$("#mind-task-completion").children("span").text("无")}y.remove();u.remove();$("#mind-task-start").children("span").text(A.start||"无");$("#mind-task-end").children("span").text(A.end||"无");$("#mind-task-assigned").val(A.assigned)}else{$("#mind-task-priority").children("span").text("无");$("#mind-task-completion").children("span").text("无");$("#mind-task-start").children("span").text("无");$("#mind-task-end").children("span").text("无");$("#mind-task-assigned").val("")}mindUI.initTagsEvents()},getFile:function(b){var a=localStorage;return a.getItem("def_"+b)},saveFile:function(b,c){var a=localStorage;a.setItem("def_"+b,c)},removeFile:function(b){var a=localStorage;a.removeItem("def_"+b)},setLocalFiles:function(){var e=localStorage,b=[],j=e.getItem("localFiles")||"[]";var h=JSON.parse(j);for(var f in e){if(f=="currentId"||f=="currentTitle"||f.indexOf("def_local")>=0){continue}else{if(f.indexOf("def_")<0){continue}}var d=e[f];var i=JSON.parse(d);var a=f.substring(4);if(!g(a,h)){var c={id:a,title:i.title,localId:localId};b.push(c)}}h=h.concat(b);e.setItem("localFiles",JSON.stringify(h));function g(p,o){if(o.length==0){return false}var n=false;for(var m=0,k=o.length;m<k;m++){var l=o[m];if(l.id==p){n=true;break}}return n}},loadRecentFiles:function(){if(chartId==""){return}$.ajax({url:"/mindmap/getrecentfiles",data:{team_id:teamId},success:function(f){var b=$(".mind-title-menu-con");b.html("");if(f.charts!=null){var e=f.charts;for(var d=0,a=e.length;d<a;d++){var c=e[d];var g=$('<div id="title_'+c.chartId+'" class="mind-title-menu-item"><a href="/mindmap/'+c.chartId+'">'+c.title+'</a><span style="float:right;">'+c.lastModify+"</span></div>");if(c.chartId==mindUI.chartId()){g.addClass("active")}b.append(g)}}}})},loadLocalFiles:function(){var f=localStorage,c=f.getItem("localFiles");var b=$(".mind-title-menu-con");$(".mind-title-menu-item").remove();if(c==null){return}var g=JSON.parse(c);for(var e=0,a=g.length;e<a;e++){var d=g[e];if(d.localId!=localId){continue}var h=$('<div id="title_'+d.id+'" class="mind-title-menu-item"><a>'+d.title+'</a><span class="mind-icons">&#xe622;</span></div>');if(d.id==mindUI.chartId()){h.addClass("active")}b.append(h)}$(".mind-title-menu-item").on("click",function(j){var i=$(this),l=i.attr("id");var m=l.replace("title_",""),k=i.find("a").text();mindUI.openFile(m)});$(".mind-title-menu-item .mind-icons").on("click",function(k){var j=$(this),i=j.parent(),m=i.attr("id");i.parent().find(".mind-file-delete").remove();var l=$("<div class='mind-file-delete'><span class='delete'>确认删除</span> <span class='cancel'>取消</span></div>");l.appendTo(i);l.animate({left:0},50);$(".mind-title-menu-item .delete").on("click",function(n){if(m.indexOf("title_")>=0){m=m.substring(6)}mindUI.deleteLocalFile(m);i.remove();n.stopPropagation()});$(".mind-title-menu-item .cancel").on("click",function(n){var p=$(this),o=p.parent();o.parent().find(".mind-file-delete").remove();n.stopPropagation()});k.stopPropagation()})},deleteLocalFile:function(g){var d=localStorage.getItem("localFiles");var c=JSON.parse(d),e=[];for(var b in c){var a=c[b];if(a.id!=g){e.push(a)}}var f=e[0];localStorage.setItem("localFiles",JSON.stringify(e));localStorage.removeItem("def_"+g);if(g==chartId){if(f!=null){$(".mind-title-menu-item:first").trigger("click")}else{localStorage.removeItem("localFiles");localStorage.removeItem("currentId");localStorage.removeItem("currentTitle");$(".header-item .title").text("");mind.operation.clearCanvas.call(mind);window.location.hash=""}}},isAdding:false,addHistory:function(c){if(chartId!=""&&chartId!=null){if(mindUI.isAdding){return}var a=JSON.stringify(mind.model.topic);mindUI.isAdding=true;var b=$("#history_remark").val();$.ajax({url:"/mindmap/history",type:"post",data:{id:chartId,remark:b,def:a,ignore:"def",action:"add"},success:function(d){$("#btn-histoty-save").removeClass("mind-disable");if(d.result=="over"){$.showTip("保存失败，非会员最多存储30个历史版本",3000);return}$("#history_remark").val("");$("#area-history-add").hide();$("#btn-history-add").show();mindUI.loadHistorys();if(c!=null){c()}setTimeout(function(){mindUI.isAdding=false},5000)},error:function(){window.localStorage.setItem("def_version_"+chartId,a)}})}},currentDef:null,currentDefId:null,isViewingHistory:false,loadHistorys:function(){if(chartId==""){return}$.ajax({url:"/mindmap/gethistories",data:{id:chartId},success:function(a){$("#history-container").html(a);if(a.result=="error"){$("#history-none-tip").show()}else{if($.trim(a)!=""){$("#history-none-tip").hide()}else{$("#history-none-tip").show()}}$("#history_versions").children("li").off().on("click",function(){var c=$(this),b=c.attr("def");if(b==mindUI.currentDefId){return}mindUI.currentDefId=b;c.addClass("active").siblings().removeClass("active");mindUI.getHistory(b);mindUI.isViewingHistory=true;$("#btn-history-restore").removeClass("mind-disable").addClass("active")});$("#history_versions").find(".mind-icons").on("click",function(f){var c=$(this).parent().parent();var b=c.attr("vid");if(b!=null){var d=$("<div class='mind-history-delete'><div class='text'>确认删除此版本信息？</div><div class='btns'><span class='btn-delete mind-button'>删除</span><span class='btn-cancel mind-button gray'>取消</span></div></div>");d.appendTo(c);d.find(".btn-delete").on("click",function(e){mindUI.removeHistory(b);e.stopPropagation()});d.find(".btn-cancel").on("click",function(e){d.remove();e.stopPropagation()})}f.stopPropagation()})}})},getHistory:function(a){if(a==null){return}$.ajax({url:"/mindmap/getdefinition",data:{definitionId:a},success:function(b){mindUI.openHistory(b.definition);$("#mind-history-tip").css({top:56,marginLeft:-122}).show().find(".mind-tip-text").html("您在正浏览一个历史版本<a href='javascript:' style='margin-left: 10px;color:#0080FF' onclick='mindUI.closeHistory()'>点击退出</a>")}})},removeHistory:function(a){if(a==null){return}$.ajax({url:"/mindmap/history",type:"post",data:{id:chartId,vid:a,action:"remove"},success:function(b){mindUI.loadHistorys();if(mindUI.isViewingHistory){mindUI.closeHistory()}mindUI.isViewingHistory=false}})},openHistory:function(b){if(this.currentDef==null){var d=mind.opts.chartId;var c=JSON.stringify(mind.model.topic);this.currentDef=c}mind.operation.clearCanvas.call(mind);var a=new mindDesigner("#mind_con",{chartId:chartId,readonly:true},b);mind.operation.setDisable.call(mind);a.util.clearSelect()},closeHistory:function(){var a=mindUI.currentDef;var b=mind.opts.chartId;chartId=b;mind.operation.clearCanvas.call(mind);mind=new mindDesigner("#mind_con",{chartId:chartId},a);mind.operation.setEnable.call(mind);this.currentDef=null;mindUI.isViewingHistory=false;mindUI.currentDefId=null;$("#history_versions").find(".active").removeClass("active");$("#btn-history-restore").addClass("mind-disable").removeClass("active");$("#mind-history-tip").css({top:-56}).hide()},restoreHistory:function(){var b=$("#history_versions").children(".active");if(b.length){var a=b.attr("def");$.ajax({url:"/mindmap/restore",data:{def_id:a,chart_id:chartId},success:function(c){mindUI.currentDef=c.def;mindUI.closeHistory()}})}},saveTitle:function(b){if(b.length>30){b=b.substring(0,30)}if(b==chartTitle){return}chartTitle=b;var a={action:"changeTitle",title:b};mindColla.send([a]);mindUI.loadRecentFiles()},setLocalFileTitle:function(h,g){var d=window.localStorage;var e=d.getItem("localFiles");var f=JSON.parse(e);for(var c=0,a=f.length;c<a;c++){var b=f[c];if(b.localId!=localId){continue}if(b.id==h){b.title=g}}d.setItem("localFiles",JSON.stringify(f))},setLocalFileId:function(h,b){var e=window.localStorage;var f=e.getItem("localFiles");var g=JSON.parse(f);for(var d=0,a=g.length;d<a;d++){var c=g[d];if(c.localId!=localId){continue}if(c.id==h){c.id=b;break}}e.setItem("localFiles",JSON.stringify(g))},addLocalFile:function(f,e){var b=window.localStorage;var c=b.getItem("localFiles");var d=JSON.parse(c);var a={id:f,title:e,localId:localId};d.push(a);b.setItem("localFiles",JSON.stringify(d))},saveOnline:function(){var e=$("#btnsave"),f=$(".mind-save-dlg"),c=f.find(".mind-save-dlg-before");var b=1,d=f.find("#save-timeout");d.text(10);mindUI.showMenu(e,f,function(){var h=window.setInterval(function(){d.text(10-b);b++;if(b==11){clearInterval(h);g();a()}},1000);f.find("[tit=syncnow]").off().on("click",function(){window.clearInterval(h);$.mask("close");g();a()});f.find("[tit=syncsaveas]").off().on("click",function(){window.clearInterval(h);g(true);$.mask("close");a()});f.find("[tit=synccancel]").off().on("click",function(){window.clearInterval(h);$.mask("close");a()})},c);function a(){b=1;f.hide()}function g(h){var k=mind.opts.chartId;var j=chartTitle||"中心主题";var i=mindUI.getFile(k);mindUI.doSync(k,i,j,h)}},savePublish:function(f){var b=$("#publish_category").val();var e=$("#publish_language").val();var d=$("#publish_description").val();var a=$("#publish_tags").val();var c=a.replace(/，/ig,",").split(",");c=this.removeFromArray(c,"");if(c.length==0){$("#publish_tags").attr("placeholder","请输入标签");$("#publish_tags").focus();return}$("#publish_dlg_save").addClass("mind-disable");$.ajax({url:"/folder/publish",type:"post",data:{id:chartId,status:"public",language:e,industry:b,description:d,tags:c,_public_edit:$("#public_edit").is(":checked"),_public_clone:$("#public_clone").is(":checked")},traditional:true,success:function(g){$("#publish_dlg_save").removeClass("mind-disable");f()}})},showThemeOperate:function(b){$(".mind-theme-dlg").hide();$(".mind-theme-customise-dlg").hide();var a=$(".mind-exists-dlg");a.show();$.mask();$("#btn-style-overwrite").off("click").on("click",function(){mind.style.setThemeOverWrite.call(mind,b,function(){a.hide();$.mask("close")})});$("#btn-style-remain").off("click").on("click",function(){mind.style.setThemeDirect.call(mind,b);a.hide();$.mask("close")});$("#btn-style-cancel").off("click").on("click",function(){a.hide();$.mask("close")})},renderCustomiseThemes:function(a){var f=[],b=$("#mind-customise-themes-list");if(a.length==0){b.html("<div style='height:224px;line-height:200px;text-align:center;font-size:18px;color:#999;'><span style='font-size:28px;' class='mind-icons'>&#xe65d;</span> 未找到自定义的主题风格</div>");return}for(var e=0;e<a.length;e++){var h=a[e];var d=JSON.parse(h.theme);if(d!=null){var g=h.themeName||"未命名风格";var c=d.background;if(d.background=="#ffffff"||d.background=="rgb(255,255,255)"){c="#e7e6e5"}f.push("<div cid='"+h.id+"' themeId='"+d.id+"' style='color:"+c+"' class='theme-item'><span class='mind-icons icons-theme'>&#xe65d;</span><input type='text' class='theme-item-title' value='"+g+"' /><div class='theme-item-date'>"+h.updateTime.substring(0,16)+"</div><div class='theme-item-op'><span title='编辑主题风格' class='mind-icons disable icons-edit'>&#xe651;</span><span title='删除主题风格' class='mind-icons icons-close'>&#xe618;</span></div></div>")}}f.push("<div style='clear:both;'></div>");b.html(f.join(""));b.find(".theme-item > .icons-theme").on("click",function(){var i=$(this).parent().attr("themeId");mind.style.setTheme.call(mind,i)});b.find(".theme-item-title").off().on("blur",function(){var j=$(this).parent().attr("themeId");var i=$(this).val();mindUI.saveThemeName(j,i)});b.find(".theme-item-op > .icons-close").on("click",function(l){var k=$(this);var j=k.parent().parent();var m=j.attr("cid");var i=$("#mind-confirm-themedel");k.confirm({content:"确定要删除当前主题？",width:120,height:40,onConfirm:function(){mindUI.removeCustomiseTheme(m,function(){mindUI.loadCustomiseThemesOn();j.remove()})}});l.stopPropagation()});b.find(".theme-item-op > .icons-edit").on("click",function(p){var m=$(this);var q=m.parent().parent();var r=q.attr("themeid");var k=sessionStorage.getItem("customiseThemes");var o=null;if(k!=null){var j=JSON.parse(k);for(var n=0;n<j.length;n++){var l=j[n];if(l.id==r){o=l;break}}mindUI.editCustomiseId=o.id;mindUI.showCustomiseStyles(o)}p.stopPropagation()})},saveThemeName:function(b,a){$.ajax({url:"/mindmap/savethemename",data:{id:b,val:a},type:"post",success:function(c){if(c.result=="success"){$.showTip("风格名称保存成功",1000)}}})},removeCustomiseTheme:function(b,a){$.ajax({url:"/mindmap/deletetheme",data:{id:b},success:function(c){if(c.result=="success"){a()}else{$.showTip("删除失败",1000)}},error:function(){}})},showCustomiseStyles:function(b){var c=$(".mind-theme-customise-dlg");var a=c.find("div[tit=mind-tabs-styles]");$("#mind-tabs-styles").addClass("selected").siblings().removeClass("selected");c.css({height:624,marginTop:-312});a.show().siblings().hide();mindUI.customiseTheme=b;mindUI.renderTopic();c.find("#btn-customise-save").show()},showCustomiseThemes:function(b){var c=$(".mind-theme-customise-dlg");var a=c.find("div[tit=mind-tabs-canvas]");$("#mind-tabs-themes").addClass("selected").siblings().removeClass("selected");c.css({height:348});a.show().siblings().hide();c.find("#btn-customise-save").show()},loadCustomiseThemesOn:function(a){if(chartId!=""&&chartId!=null){$.ajax({url:"/mindmap/getthemes",type:"post",success:function(f){var b=f.themes;if(b==null){a()}else{var c=[];for(var e=0;e<b.length;e++){var d=b[e];c.push(JSON.parse(d.theme))}mindUI.renderCustomiseThemes(b);sessionStorage.setItem("customiseThemes",JSON.stringify(c))}},error:function(){}})}},initStructure:function(){var c=$("#mind-structures"),b=$(".mind-dock-structure");b.off().on("click",function(d){c.fadeIn(300).css({top:152,left:50});d.stopPropagation()});$(document).on("click.structure",function(d){c.hide();d.stopPropagation()});c.children().on("click",function(f){var d=$(this),g=d.attr("tp");mind.operation.changeStructure.call(mind,g,function(e){b.find(".mind-icons").html(e)})});if(mind!=null){var a=mind.model.topic.structure;if(a=="mind_right"){b.children().html("&#xe6fb;")}if(a=="mind_org"){b.children().html("&#xe6fd;")}}},saveTheme:function(b,d){if(chartId!=""&&chartId!=null){var c=b.id;var a=JSON.stringify(b);$.ajax({url:"/mindmap/savetheme",type:"post",data:{id:c,theme:a,ignore:"theme"},success:function(e){if(e.result=="over"){$.showTip("最多只能自定义五种风格",1000)}else{if(e.result=="error"){$.showTip("保存失败",1000)}}d()},error:function(){$.showTip("保存失败",1000)}})}},initCustomise:function(d){var f=$(".mind-theme-customise-dlg");mindUI.customiseTheme=mind.util.copy(d);var e=$("#previewTopic"),g="centerTopic";mindUI.loadCustomiseThemesOn();$("#mind-customise-topic").off().on("click",function(){var j=$(this);$("#mind-customise-topic-list").css("z-index",10).dropdown({target:j,width:200,onSelect:function(l){var k=l.text();j.children("span").text(k);e.text(k);g=l.attr("tp");if(mindUI.customiseTheme[g]==null){mindUI.customiseTheme[g]=$.extend({},mindUI.customiseTheme.secTopic)}if(g=="centerTopic"){$("#linestylecon").addClass("mind-disable");$("#previewLine").hide()}else{$("#linestylecon").removeClass("mind-disable");$("#previewLine").show()}mindUI.renderTopic(g);j.removeClass("selected")},onClose:function(){j.removeClass("selected")}})});$("#mind-tabs-themes").off().on("click",function(){$(this).addClass("selected").siblings().removeClass("selected");var j=f.find("div[tit=mind-tabs-themes]");f.css({height:385,marginTop:-190});f.find("#btn-customise-save").hide();j.show().siblings().hide()});$("#mind-tabs-styles").off().on("click",function(){mindUI.customiseTheme=mind.util.copy(d);mindUI.showCustomiseStyles()});$("#mind-tabs-canvas").off().on("click",function(){mindUI.showCustomiseThemes()});$("#mind-customise-size").numberBox({callback:function(j){j=j+"px";mindUI.customiseTheme[g]["font-size"]=j;mindUI.renderTopic(g)}});$("#mind-customise-paddingt").numberBox({width:60,inputWidth:36,callback:function(j){i()}});$("#mind-customise-paddingr").numberBox({width:60,inputWidth:36,callback:function(j){i()}});$("#mind-customise-paddingb").numberBox({width:60,inputWidth:36,callback:function(j){i()}});$("#mind-customise-paddingl").numberBox({width:60,inputWidth:36,callback:function(j){i()}});function i(){var j=$(".mind-number-box.padding").map(function(){return $(this).children("input").val()}).get().join(" ");mindUI.customiseTheme[g]["padding"]=j;mindUI.renderTopic(g)}$("#mind-customise-font").off().on("click",function(){var j=$(this);$("#mind-font-list").css("z-index",10).dropdown({target:j,onSelect:function(l){var k=l.text();j.children("span").text(k);mindUI.customiseTheme.common.family=k;j.removeClass("selected");mindUI.renderTopic(g)},onClose:function(){j.removeClass("selected")}})});$("#mind-customise-color").off().on("click",function(){var k=$(this);var j=k.css("color");a(j,k,function(l){mindUI.customiseTheme[g]["color"]=l;mindUI.renderTopic(g)})});$("#mind-customise-b").off().on("click",function(){var j=$(this);if(j.hasClass("selected")){mindUI.customiseTheme.common.bold=false;j.removeClass("selected")}else{mindUI.customiseTheme.common.bold=true;j.addClass("selected")}mindUI.renderTopic(g)});$("#mind-customise-i").off().on("click",function(){var j=$(this);if(j.hasClass("selected")){mindUI.customiseTheme.common.italic=false;j.removeClass("selected")}else{mindUI.customiseTheme.common.italic=true;j.addClass("selected")}mindUI.renderTopic(g)});$("#mind-customise-bw").off().on("click",function(){var j=$(this);$("#mind-customise-borderw").css("z-index",10).dropdown({target:j,onSelect:function(l){var k=l.text();j.children("span").text(k);if(k=="无"){k="0"}mindUI.customiseTheme[g]["border-width"]=k;mindUI.customiseTheme[g]["border-style"]="solid";mindUI.renderTopic(g);j.removeClass("selected")},onClose:function(){j.removeClass("selected")}})});$("#mind-customise-bc").off().on("click",function(){var k=$(this);var j=k.css("color");a(j,k,function(l){mindUI.customiseTheme[g]["border-color"]=l;mindUI.renderTopic(g)})});$("#mind-customise-canvasbg").off().on("click",function(){var k=$(this);var j=k.css("color");a(j,k,function(l){mindUI.customiseTheme.background=l;$(".mind-customise-prev").css("background",l)})});$("#mind-customise-linec").off().on("click",function(){var k=$(this);var j=k.css("color");a(j,k,function(l){if(mindUI.customiseTheme[g]["lineStyle"]==null){mindUI.customiseTheme[g]["lineStyle"]={}}mindUI.customiseTheme[g]["lineStyle"]["lineColor"]=l;document.getElementById("previewLine").querySelector("path").setAttributeNS("","stroke",l)})});$("#mind-customise-linet").off().on("click",function(){var j=$(this);$("#mind-customise-linet-list").css("z-index",10).dropdown({target:j,onSelect:function(l){var k=l.attr("tp"),m=l.text();j.children("span").text(m);if(mindUI.customiseTheme[g]["lineStyle"]==null){mindUI.customiseTheme[g]["lineStyle"]={}}mindUI.customiseTheme[g]["lineStyle"]["lineType"]=k;j.removeClass("selected")},onClose:function(){j.removeClass("selected")}})});$("#mind-customise-linew").off().on("click",function(){var j=$(this);$("#mind-customise-linew-list").css("z-index",10).dropdown({target:j,onSelect:function(l){var k=l.attr("tp");j.children("span").text(k+"px");if(mindUI.customiseTheme[g]["lineStyle"]==null){mindUI.customiseTheme[g]["lineStyle"]={}}mindUI.customiseTheme[g]["lineStyle"]["lineWidth"]=k;j.removeClass("selected");document.getElementById("previewLine").querySelector("path").setAttributeNS("","stroke-width",k)},onClose:function(){j.removeClass("selected")}})});$("#mind-customise-bs1").off().on("click",function(){b("0px");$("#mind-customise-bs1").addClass("selected");$("#mind-customise-bs2").removeClass("selected");$("#mind-customise-bs3").removeClass("selected")});$("#mind-customise-bs2").off().on("click",function(){b("5px");$("#mind-customise-bs2").addClass("selected");$("#mind-customise-bs1").removeClass("selected");$("#mind-customise-bs3").removeClass("selected")});$("#mind-customise-bs3").off().on("click",function(){$("#mind-customise-bs3").addClass("selected");$("#mind-customise-bs2").removeClass("selected");$("#mind-customise-bs1").removeClass("selected");b("30px")});$("#mind-customise-fill").off().on("click",function(){var k=$(this);var j=k.css("color");a(j,k,function(l){mindUI.customiseTheme[g]["backgroundColor"]=l;mindUI.renderTopic(g)})});$("#mind-customise-sd").off("").on("click",function(){var j=$(this),k="none";if(j.hasClass("selected")){j.removeClass("selected")}else{k="1px 2px 6px #aaa";j.addClass("selected")}h(k)});mindUI.renderTopic();function b(j){mindUI.customiseTheme[g]["border-radius"]=j;mindUI.renderTopic(g)}function h(j){if(j=="none"){delete mindUI.customiseTheme[g]["box-shadow"]}else{mindUI.customiseTheme[g]["box-shadow"]=j}mindUI.renderTopic(g)}function c(){if(g=="centerTopic"){}}function a(j,l,m){var k=mind.util.getHexColor(j);$.colorpicker({target:l,setColor:j,onSelect:function(n){if(n==null){}else{n="#"+n;l.css("color",n);if(m!=null){m(n)}}l.removeClass("selected")},onClose:function(){l.removeClass("selected")}});$("#color-hex-value").val(k.hex)}$("input[name=mind_upload_bg_file]").off("change").on("change",function(k){var j=this.files[0].type;if($.trim($(this).val())==""){return}if(j.indexOf("image")>=0){$.loading();$("#upload_mind_img_bg").submitForm({success:function(l){if(l.result=="size_wrong"){$.loading("close");$.showTip("图片大小不能超过500k",2500);return}if(l.result=="type_wrong"){$.loading("close");$.showTip("只能上传图片",2500);return}if(l.img_url==null){$.loading("close");$.showTip("上传失败",1500);return}if(l.img_url!=""){var m=new Image();m.src=l.img_url;m.onload=function(){$(".mind-customise-prev").css("background","url("+l.img_url+")");mindUI.customiseTheme.background="url("+l.img_url+")";$.loading("close")}}},error:function(){$.loading("close")}})}else{}})},customiseTheme:null,editCustomiseId:null,renderTopic:function(d){if(mindUI.customiseTheme==null){mindUI.customiseTheme=mind.util.copy(mind.style.themes.theme3)}var b={},a=mindUI.customiseTheme,c=$("#previewTopic");if(d=="centerTopic"||d==null){b=a.centerTopic}else{if(d=="secTopic"){b=a.secTopic}else{if(d=="childTopic"){b=a.childTopic}else{if(d=="freeTopic"){if(a.freeTopic){b=a.freeTopic}else{b=a.secTopic}}}}}b=$.extend(b,a.common);b["font-family"]=b.family;b["font-weight"]=b.bold?"bold":"normal";b["font-style"]=b.italic?"italic":"normal";delete b.family;delete b.bold;delete b.italic;c.removeAttr("style");c.css(b);mindUI.initStyles(b);$(".mind-customise-prev").css("background",a.background)},initStyles:function(d){var f=$("#previewTopic");$("#mind-customise-font").children("span").text(d.family);$("#mind-customise-size").children("input").val(d["font-size"]);if(d.padding!=null){var h=d.padding.split(" ");$("#mind-customise-paddingt").children("input").val(h[0]);$("#mind-customise-paddingr").children("input").val(h[1]);$("#mind-customise-paddingb").children("input").val(h[2]);$("#mind-customise-paddingl").children("input").val(h[3])}if(d.lineStyle!=null){var a=d.lineStyle.lineColor,b=d.lineStyle.lineWidth,c=d.lineStyle.lineType;var k=(c=="curv"||c=="curve")?"曲线":c=="straight"?"直线":c=="roundBroken"?"圆角折线":"折线";var j=document.getElementById("previewLine").querySelector("path");j.setAttributeNS("","stroke",a);j.setAttributeNS("","stroke-width",b);$("#mind-customise-linew").children("span").text(b+"px");$("#mind-customise-linec").css("color",a);$("#mind-customise-linet").children("span").text(k)}if(d["font-wdith"]=="bold"){$("#mind-customise-b").addClass("selected")}if(d["font-style"]=="italic"){$("#mind-customise-i").addClass("selected")}$("#mind-customise-color").css("color",d.color);$("#mind-customise-bs1,#mind-customise-bs2,#mind-customise-bs3").removeClass("selected");if(d["border-radius"]!=null){var i=d["border-radius"].replace("px","");if(Number(i)<1){$("#mind-customise-bs1").addClass("selected")}else{if(Number(i)<10){$("#mind-customise-bs2").addClass("selected")}else{if(Number(i)>10){$("#mind-customise-bs3").addClass("selected")}}}}if(d["border-width"]!=null){$("#mind-customise-bw").children("span").text(d["border-width"])}else{if(d.border==null){$("#mind-customise-bw").children("span").text("无")}else{var g=f.css("border-width"),e=f.css("border-color");$("#mind-customise-bw").children("span").text(g);$("#mind-customise-bc").css("color",e)}}if(d["box-shadow"]!=null){$("#mind-customise-sd").addClass("selected")}else{$("#mind-customise-sd").removeClass("selected")}$("#mind-customise-fill").css("color",d.backgroundColor)},removeFromArray:function(c,b){var a=c.indexOf(b);if(a>=0){c.splice(a,1)}return c},isOperated:false,isSaving:false,doSyncInterval:function(){window.setInterval(function(){if(mindUI.isOperated){var b=chartTitle||"中心主题";var c=mind.opts.chartId;var a=mindUI.getFile(c);mindUI.doSync(c,a,b,false)}},3000)},doSync:function(g,e,f,a){var d=new Date().getTime();if(mindUI.saveTamp!=0&&d-mindUI.saveTamp<3000){return}if(mindUI.isSaving){return}mindUI.isSaving=true;$.ajax({url:"/mindmap/sync",type:"post",data:{id:g,def:e,shapecount:e.split('"children":[').length,ignore:"def",team:teamId=="null"?"":teamId,title:f,savenew:a},success:function(h){if(a!=true){}else{mindUI.addLocalFile(h.chartId,f)}mind.opts.chartId=h.chartId;mindUI.saveTamp=d;mindUI.isOperated=false;mindUI.isSaving=false},error:function(){mindUI.isSaving=false}});var c=$("#btnsave").children(),b=0;c.addClass("rotate1").css("color","rgb(80, 194, 139)");setTimeout(function(){c.removeClass("rotate1").css("color","#666")},1000)},getChart:function(c){if(chartId==""||chartId==null){return}$.ajax({url:"/mindmap/getchart",type:"post",data:{id:chartId},success:function(d){if(c!=null){c(d)}},error:function(){}});var b=$("#btnsave").children(),a=0;b.addClass("rotate1").css("color","rgb(80, 194, 139)");setTimeout(function(){b.removeClass("rotate1").css("color","#666")},1000)},createNew:function(){window.location.href="/mindmap/new?category=mind_right&status=private"},openFile:function(b){if(chartId==b){return}$.loading();chartId=b;mind.operation.clearCanvas.call(mind);mind.model.groupList.clearData();mind=null;mind=new mindDesigner("#mind_con",{chartId:chartId},null);var a=$(".mind-title-menu");mindUI.closeMenu(a);mindUI.loadHistorys()},saveFeedBack:function(b){var a=$.trim($("#feedback_message").val());if(a==""){$("#feedback_message").val("").focus();return}$.ajax({url:"/support/save_ask",data:{content:a,url:location.href},success:function(c){if(b!=null){b()}}})},showMenu:function(c,d,e,a){$(".mind-title-menu").hide();$(".mind-theme-dlg").hide();$(".mind-image-dlg").hide();$(".mind-save-dlg").hide();var b=c.offset().left+(c.outerWidth()-d.outerWidth())/2;if(b+d.width()>$(window).width()){b=$(window).width()-d.width()-17;d.find("::before").css({left:"60%"})}d.css({left:b}).show().css({left:b,top:c.outerHeight()+15,opacity:1,zIndex:9});if(e!=null){e()}if(a!=null){a.css({left:c.offset().left-d.offset().left+c.outerWidth()/2})}},closeMenu:function(a){a.animate({top:15,opacity:0,zIndex:0},100,function(){a.hide()})},loadThemes:function(d){if(d==null){return}var a=d.style.themes;var b=$("#mind-themes");var c=["<ul>"];$.each(a,function(e,g){var f="<li><div tit='"+e+"'><img src='"+g.thumbUrl+"'/></div></li>";c.push(f)});c.push("</ul>");b.prepend(c.join(""));$("#mind-themes").find("div[tit]").on("click",function(){var f=$(this).attr("tit");var e=d.model.topic;d.style.setTheme.call(d,f)})},htmlEncode:function(b){var a="";if(b.length==0){return""}a=b.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/ /g,"&nbsp;");a=a.replace(/\'/g,"&#39;");a=a.replace(/\"/g,"&quot;");return a},htmlDecode:function(b){var a="";if(b.length==0){return""}a=b.replace(/&amp;/g,"&");a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&nbsp;/g," ");a=a.replace(/&#39;/g,"'");a=a.replace(/&quot;/g,'"');return a},showProcess:function(){var a=$("<div id='top-tip-uploading'></div>").appendTo("body")},initTagsEvents:function(){$("#mind-topic-tags").find(".mind-icons").on("click",function(){var b=$(this),a=b.parent();b.remove();var c=$.trim(a.text());a.remove();mind.tags.removeTag.call(mind,c)})},showUploading:function(){var a=$("<div class='mind-upload-tip'><span class='mind-icons rotate1'>&#xe65b;</span> <span>正在上传中......</span></div>");a.appendTo("body");a.css({top:60}).show()},hideUploading:function(){$(".mind-upload-tip").remove()},showWeixin:function(a){$.ajax({url:"/view/getlink",data:{chartId:chartId},success:function(d){if(d.viewLinkId!=""){var b=$("<div></div>").appendTo("body");b.css({position:"absolute",width:200,height:216,left:"50%",top:"40%",marginLeft:-100,marginTop:-100,textAlign:"center",zIndex:9999999,border:"1px solid #ccc",background:"#fff",boxShadow:"1px 1px 12px #bbb"});var c=new QRCode(b[0],{width:180,height:180});b.find("img").css({width:"180px",height:"180px",marginTop:10,marginLeft:10}).after("<div>微信扫一扫 分享</div>");c.makeCode(d.viewLinkId);$(document).off("mousedown.weixin").on("mousedown.weixin",function(){b.remove()})}}})}};var mindTip={};mindTip.globalTopTip=function(d,c,b,f,g){if(typeof d=="undefined"){return}if(b==null){b=5000}if(c==null){c="top_success"}var e=$("#global_top_dialog");if(e.length>0){e.remove()}e=$('<div id="global_top_dialog" class="global_top_dialog"><div class="left_arrow"></div>'+d+'<div class="right_arrow"></div></div>').appendTo("body");e.addClass(c);if(g){e.find(".left_arrow").remove();e.find(".right_arrow").remove();e.addClass("noarrow")}var a=e.outerWidth();if(f){e.css("top",$(f).offset().top+"px")}else{if($("#header").length==0){e.css("top","0px")}}e.css({"margin-left":-(a*0.5)+"px"}).show();setTimeout(function(){e.addClass("show");setTimeout(function(){e.removeClass("show");setTimeout(function(){e.fadeOut("slow").remove()},250)},b)},50)};mindTip.loadingball=function(b){if(b.close){$(".ball-spinner").hide();return}var a=b.con;if(!a){a=$("body")}var c=a.children(".ball-spinner");if(c.length>0){c.show()}else{$('<div class="ball-spinner center-middle"><div class="ball1"></div><div class="ball2"></div><div class="ball3"></div>').appendTo(a)}if(b.css&&typeof(b.css)=="object"){$(".ball-spinner>div").css(b.css)}};var mindShare={publish:{source:'<div id="publish_toedit" class="pubpo-tab dialog-win-con"><div class="toedit-des">当前文件已发布（公开）到ProcessOn，您可以：</div><div class="publish-content"><div id="btn_submit_private"><span class="mind-icons">&#xe7bb;</span>取消发布</div><div class="item-seq">或者</div><div id="to_publish_edit"><span class="mind-icons">&#xe644;</span>修改发布信息</div></div><div class="mind-dlg-buttons"><span class="mind-button pubdialog-close">关闭</span></div></div><div id="publish_verifying" class="pubpo-tab dialog-win-con"><div class="toedit-des">当前文件正在进行发布审核，一般为1-3个工作日，请耐心等待</div><div class="publish-content"><div id="btn_verifying"><span class="mind-icons">&#xe61e;</span>审核中…</div><div class="item-seq">或者</div><div id="to_publish_edit"><span class="mind-icons">&#xe644;</span>修改发布信息</div></div><div class="mind-dlg-buttons"><span class="mind-button pubdialog-close">关闭</span></div></div><div id="publish_topublic" class="pubpo-tab dialog-win-con"><div class="pub-explain">发布后，文件将公开到 ProcessOn，所有用户都可以看到，供大家学习交流；您也可以设置文件的克隆价格，分享知识的同时还可以获得收益。</div><ul class="form"><li><div class="title">文件描述：</div><textarea id="publish_description" class="textarea txt" placeholder="请您描述文件（必填）"></textarea></li><li><div class="title">文件标签：</div><div id="publish_addtags" class="feedTags"><div id="tag_items"></div><input id="tag_input" class="tag-txt" type="text" placeholder="输入内容按回车键添加标签(必填)"></div></li><li><div class="title">开放克隆</div><div class="content"><div class="radio-btn-group"><input type="radio" name="public_clone" id="no_clone" class="clone-radio"><label for="no_clone">不允许克隆</label><span class="label-exp">所有人只限于查看此文件，但是不能克隆</span></div><div class="radio-btn-group"><input id="public_clone_free" type="radio" class="clone-radio" name="public_clone"><label for="public_clone_free">免费克隆</label><span class="label-exp">所有人都可以查看且免费克隆（另存为）此文件</span></div><div class="radio-btn-group"><input id="public_clone_pay" type="radio" class="clone-radio " name="public_clone"><label for="public_clone_pay">付费克隆</label><span class="label-exp">用户可以查看文件，付费后，可以克隆您的文件</span></div></div></li><li class="clone-price"><div class="title">克隆价格</div><div class="content"><input class="setprice-btn txt" id="setprice" type="text" name="set_price" placeholder="克隆价格为数字，最多1位小数"><span style="margin-left:10px;">元</span><a title="点我了解详情" href="/support#user-template" target="_blank"><span class="icons mind-icons" style="color: #888;cursor: pointer;margin-left:10px;">&#xe696;</span></a></div></li></ul><div class="bot-line"><div class="agreement-group"><input id="agreement" type="checkbox" name="agreement" checked /><label for="agreement">点击发布表示您同意我们的<a href="/tos" target="_blank" class="agreement-detail">服务条款</a></label></div><div class="mind-dlg-buttons" style="padding-right:0px;"><span id="btn_submit_publish" class="mind-button  pub-btn">发布</span><span class="mind-button gray pubdialog-close">关闭</span></div></div></div>',execute:function(e){$.ajax({url:"/view/chart/"+e,data:{},success:function(h){var g=h.chart;d(g.status);$("#tag_items").children("span").remove();$(".clone-price").hide();if(g.tags!=null&&g.tags.length>0){for(var f=0;f<g.tags.length;f++){a(g.tags[f])}}$("#publish_description").val(mindUI.restoreXss(g.description));if(g.template==true){$("#public_clone_pay").attr("checked",true);$(".clone-price").show()}if(g.publicClone&&g.publicClonePrice>0){$("#public_clone_pay").attr("checked",true);$(".clone-price").show();$(".setprice-btn").val(g.publicClonePrice)}else{if(g.publicClone){$("#public_clone_free").attr("checked",true)}else{$("#no_clone").attr("checked",true)}}}});$("#mind-publish-dlg").on("click","#to_publish_edit",function(){$(".pubpo-tab").hide();$("#publish_topublic").show()});$("#publish_addtags").on("click",function(f){$("#tag_input").focus()});$("#tag_input").off("keyup.input").on("keyup.input",function(g){if($.trim($(this).val()).length>30){$(this).val($.trim($(this).val()).substring(0,30))}var f=g.which;if(f==13){a($("#tag_input").val());$("#tag_input").val("")}if(f==188){a($("#tag_input").val().substr(0,$("#tag_input").val().length-1));$("#tag_input").val("")}$("#publish_addtags").scrollTop($(".input_item_box").height())}).off("keydown.delete").on("keydown.delete",function(f){if(f.which==8&&$("#tag_input").val()==""){$("#tag_items span:last-child").remove()}}).suggest({url:"/tags/suggest",valueField:"tagName",format:function(f){return f.tagName},onEnter:function(){a();$(".feedTags").scrollTop($(".input_item_box").height())}});$("#tag_items").find(".close-tag").die().live("click",function(){$(this).parent().remove();if($("#tag_items").children("span").length<5){$("#tag_input").val("").focus()}});$(".clone-radio").off().on("change",function(){var g=$("#public_clone_pay").prop("checked"),f=$("#btn_submit_publish");if(g){$(".clone-price").show();f.text("提交审核");return}$(".clone-price").hide();f.text("发布")});$("#agreement").on("change",function(){var g=$(this).prop("checked"),f=$("#btn_submit_publish");if(!g){f.disable();return}f.enable()});$("#clone_price").off().on("blur",function(){var g=$(this);var f=g.val();if(isNaN(f*1)){g.inputTip({text:"克隆价格只能输入数字",pos:"rightout"})}else{if($.trim(f).length==0){g.val(0)}else{if(f*1<0.1){g.inputTip({text:"您输入的克隆价格不在规定范围",pos:"rightout"})}}}});$("#btn_submit_publish").off().on("click",function(){var g="verifying";var f=$("#public_clone_free").prop("checked"),h=$("#no_clone").prop("checked");if(f||h){g="public"}b(g)});$("#btn_submit_private").off().on("click",function(){var f="private";b(f)});function b(l){var g=$("#publish_description"),f=$(".clone-radio:checked");var m={};m.id=e;m.description=g.val();m.tags=c();m.status=l;m._public_clone=($("#no_clone")[0].checked==true)?"false":"true";m._public_clone_price=$("#setprice").val();m.ignore="description";if(l!="private"){if(m.description.length<15){mindTip.globalTopTip("请输入文件描述，至少15个字","top_error",3000,$("#mind-publish-dlg"),true);g.focus();return}if(m.tags.length==0){mindTip.globalTopTip("请输入文件标签","top_error",3000,$("#mind-publish-dlg"),true);$("#publish_addtags").find("input").focus();return}if(f.length<1){mindTip.globalTopTip("您需要选择是否开放克隆","top_error",3000,$("#mind-publish-dlg"),true);return}var j=$("#public_clone_pay").prop("checked");if(j){var k=$("#setprice");var i=k.val().trim();if(i.length==0){mindTip.globalTopTip("请您输入克隆价格","top_error",3000,$("#mind-publish-dlg"),true);k.focus();return}else{if(!/^(\d+\.\d{1,1}|\d+)$/.test(i)){mindTip.globalTopTip("克隆价格需为数字，最多一位小数","top_error",3000,$("#mind-publish-dlg"),true);k.focus();return}else{if(i<0.1){mindTip.globalTopTip("您输入的克隆价格小于规定范围","top_error",3000,$("#mind-publish-dlg"),true);k.focus();return}}}}}var h=l=="verifying"?"chart/verify":"publish";$.ajax({url:"/folder/"+h,data:m,success:function(n){if(n.result=="clone"){mindTip.globalTopTip("克隆的文件暂不允许发布","top_error",3000,$("#mind-share-dlg"),true);return}else{if(n.result=="rename"){mindTip.globalTopTip("未命名文件不允许发布，请修改文件标题后再发布","top_error",3000,$("#mind-share-dlg"),true);return}}if(l=="private"){mindTip.globalTopTip("文件已经取消发布，已处于私密状态",null,3000,$("#mind-publish-dlg"),true)}d(l)}})}$("#mind-publish-dlg").on("click",".pubdialog-close",function(){var f=$("#mind-publish-dlg");$.mask("close");f.hide();$(window).unbind("resize.dialog")});function d(f){var g=$(".pubpo-tab");if(f=="public"){g.hide();$("#publish_toedit").show()}else{if(f=="verifying"){g.hide();$("#publish_verifying").show()}else{g.hide();$("#publish_topublic").show();$("#publish_topublic").find("textarea").focus()}}}function a(g){if(typeof g=="undefined"){g=$("#tag_input").val();$("#tag_input").val("")}if($("#tag_items").children("span").length>=5){$("#tag_input").inputTip({text:"最多添加五个标签",pos:"rightout"});return}if(g!=""){var f=$("#tag_items").find(".tagitem").map(function(){return $(this).find("input").val()}).get();if($.inArray(g,f)<0){$("#tag_items").append("<span class='tagitem'><span class='close-tag mind-icons'>&#xe622;</span><input type='hidden' name='tags' value='"+g+"'/>"+g+"</span>");$("#tag_items").show()}}}function c(){a();var f=$("#tag_items").find(".tagitem").map(function(){return $(this).find("input").val()}).get();return f}}},viewlink:{source:'<div class="dlg-content"><h3><span class="tip1">创建浏览链接，分享给别人后，可以通过此链接来安全地浏览您的文件</span></h3><div style="margin:15px 0;"><input type="text" id="view_link_input" class="txt-input share-link-input" style="width:90%;" readonly placeholder="您还没有给文件创建分享链接"></div><div><span class="mind-button create">创建链接</span><div class="new-form-switch"><span class="switchbutton fl gray" val="false"><span class="switch left"><span class="mind-icons" style="color:#888;">&#xe6bc;</span></span><span class="switch-left">删除密码</span><span class="switch-right">添加密码</span></span></div><input type="text" class="txt-input input-pw" style="margin-left:10px;display:none;height:10px;" maxlength="8" placeholder="密码" /></div><div class="shareopt-group"><h3><span class="tip2">分享到社交网络</span></h3><a style="color:#3eb94e" onclick="mindUI.showWeixin(this)" class="mind-icons weixin">&#xe6e3;</a><a style="color:#ff0000" class="mind-icons weibo" target="_blank" rel="nofollow" href="http://service.weibo.com/share/share.php?appkey=4181333602&title='+chartTitle+"&url=https://www.processon.com/view/"+chartId+"&pic=https://www.processon.com/chart_image/id/"+chartId+'.png&ralateUid=2711044785">&#xe6e1;</a><a style="color:#2196f3;" class="mind-icons mingdao" target="_blank" rel="nofollow" href="http://www.mingdao.com/share?appkey=5967E9E0B4ADA1B9C23B1893ABAED0F&pic=https://www.processon.com/chart_image/id/'+chartId+".png&title="+chartTitle+"&url=https://www.processon.com/view/"+chartId+'">&#xe6e2;</a><a style="color:#228a31;" class="mind-icons douban" target="_blank" rel="nofollow" href="http://www.douban.com/share/service?name='+chartTitle+"&href=https://www.processon.com/view/"+chartId+'">&#xe6e0;</a></div></div>',execute:function(k){var i=null;var f="";$.ajax({url:"/view/getlink",data:{chartId:k},success:function(n){i=n.chart;mindShare.chart=n.chart;f=n.viewLinkId;if(f==""||f==null){a()}else{var m="false";var l=null;if(!!i.viewPassword){m="true";l=i.viewPassword}$(".switchbutton").attr("val",m);h(l);$("#view_link_input").val(f).select()}}});$(".sharedialog-close").off("click").on("click",function(l){l.stopPropagation();$(".mind-share-dlg").hide();$.mask("close")});$(".switchbutton").off().on("click",function(){var l=$(this).attr("val");if(l=="true"){$(this).attr("val",false)}else{$(this).attr("val",true)}c(this)});$("#view_link_input").on("click",function(){$(this).select();try{if(document.execCommand("copy",false,null)){mindTip.globalTopTip("链接已复制到剪切板","top_success",3000,$("#mind-share-dlg"),true)}else{}}catch(l){}});$(".input-pw").off().on("change",function(m){var l=$(this).val().trim();if(l==""){return}if(!/^[0-9a-zA-Z]+$/.test(l.trim())){mindTip.globalTopTip("只能为数字和字母的组合","top_error",3000,$("#mind-share-dlg"),true);return}j(l)});function a(){$(".dlg-content .create").text("创建链接").off().on("click",function(){e()}).next().hide().next().hide();$("#view_link_input").val("").off();$(".shareopt-group").hide()}function e(){$.ajax({url:"/view/addlink",data:{chartId:k},success:function(m){$(".switchbutton").attr("val","false");h();var l=m.viewLinkId;$("#view_link_input").val(l).select()}})}function h(l){$(".dlg-content .create").text("删除链接").off().on("click",function(){g()}).next().css("display","inline-block");b(l);$(".shareopt-group").show()}function b(l){var n=$(".switchbutton");var m=n.attr("val");if(m=="false"){n.removeClass("green").addClass("gray");n.find(".switch").removeClass("right").addClass("left");n.find(".switch .icons").show();n.find(".switch-left").hide();n.find(".switch-right").show()}else{n.removeClass("gray").addClass("green");n.find(".switch").removeClass("left").addClass("right");n.find(".switch .icons").hide();n.find(".switch-left").show();n.find(".switch-right").hide();if(!!l){$(".input-pw").show().val(l)}}}function g(){$.ajax({url:"/view/dellink",data:{chartId:k},success:function(l){a()}})}function c(n){var m=$(n).attr("val");if(m=="true"){var l=d(4);$(".input-pw").show().val(l).select();j(l)}else{$.ajax({url:"/view/removepassword",data:{chartId:k},success:function(o){$(".input-pw").val("").hide();b($(".input-pw").val())}})}}function d(n){var o=["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","123456789"];var m,p;var l="";for(p=0;p<n;p++){m=Math.floor(Math.random()*3);l+=o[m].substr(Math.floor(Math.random()*(o[m].length)),1)}return l}function j(l){$.ajax({url:"/view/addpassword",data:{viewPassword:l,chartId:k},success:function(m){b($(".input-pw").val());mindTip.globalTopTip("密码设置成功","top_success",3000,$("#mind-share-dlg"),true)}})}}},emb:{source:'<div class="embed-left"><div class="embed-preview-wrap"><div class="embed-preview"></div></div></div><div class="embed_attributes form"><div id="embed_show_tip">您可以复制下面的代码，嵌入到第三方网站中</div><textarea id="iframe_html" class="textarea txt-input" readonly="readonly" style="margin-top:10px;height:60px;width:97%;"></textarea><div class="embed-size"><label class="title" for="embed_width">宽度:</label><input type="text" id="embed_width" name="embed_width" class="txt-input" value="525"><label for="embed_width">px</label>,<label class="title" for="embed_height">高度:</label><input type="text" id="embed_height" name="embed_height" class="txt-input" value="245"><label for="embed_height">px</label></div></div>',execute:function(e){$("#iframe_html").val("");$(".embed-preview").html("");var c="/embed/mind/";var a,b;a=$("#embed_width").val();b=$("#embed_height").val();d(a,b);$("#iframe_html").select();function d(f,j){var g='<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:'+f+"px; height:"+j+'px;" src="'+(location.origin+c+e)+'"></iframe>';$("#iframe_html").val(g);$(".embed-preview-wrap").css({"margin-top":(-j/2)+"px","margin-left":(-f/2)+"px"});$(".embed-preview").html(g);var i=document.getElementById("embed_dom");i.onload=i.onreadystatechange=function(){if(!i.readyState||i.readyState=="complete"){setTimeout(function(){$(".embed-preview .preview_dis").remove();setTimeout(function(){$(".embed_obj").fadeIn()},100)},400)}}}$(".embed-size").find("input").keyup(function(){var f=$.trim($("#embed_width").val())==""?340:$.trim($("#embed_width").val());var g=$.trim($("#embed_height").val())==""?160:$.trim($("#embed_height").val());f=parseInt(f);g=parseInt(g);$(".embed-preview").find("div:first").css({width:f+"px",height:g+"px"});$(".embed-preview").find("iframe").css({width:f+"px",height:g+"px"});d(f,g)});$("#iframe_html").off().on("click",function(){$(this).select();try{if(document.execCommand("copy",false,null)){mindTip.globalTopTip("链接已复制到剪切板","top_success",3000,$("#mind-share-dlg"),true)}else{}}catch(f){}});$(".embed-preview").keydown(function(){$(".embed-size").find("input").blur()})}},image:{source:'<div class="dlg-content"><h3><span class="tip1">分享图片链接</span></h3><div><input type="text" id="img_link_input" class="txt-input" readonly style="width:95%;margin-top:10px;"><div style="clear:both;"></div></div></div>',execute:function(a){$.ajax({url:"/folder/on_line_pic/"+a,success:function(c){$("#img_link_input").show().prev().hide();var b=c.url.replace("www.processon.com","on-img.com");$("#img_link_input").val(b).off().on("click",function(){$(this).select();try{if(document.execCommand("copy",false,null)){mindTip.globalTopTip("链接已复制到剪切板","top_success",3000,$("#mind-share-dlg"),true)}else{}}catch(d){}}).select()}})}},collaboration:{loadingcolla:false,followingPage:0,followerPage:0,loadAvatar:function(b){var a="https://processon.io";var d=location.origin.toLowerCase();var c=d.indexOf(".processon.com");if(c<0){a=""}if(!b){return'<img src="/assets/imgs/on.png"/>'}else{return'<img src="'+a+"/photo/"+b+'.png"/>'}},init:function(c,b){var a=this;a.multiVal=[];a.multiType=[];a.getContacters();a.getRoleList();$(".colla-tab").off().on("click",function(){var e=$(this).attr("tit");if($(this).hasClass("active")){return}$(this).addClass("active").siblings().removeClass("active");switch(e){case"colla_users":$("#colla_users").show().siblings().hide();break;case"colla_teams":var d=$(".colla-team-user").length;if(d<1){a.getTeams()}$("#colla_teams").show().siblings().hide();break;case"colla_following":var f=$("#colla_following"),i=f.find(".colla-follow-user").length;if(i<1){f.empty();a.getCollaFollwinger("following",0)}f.show().siblings().hide();break;case"colla_follower":var h=$("#colla_follower"),g=h.find(".colla-follow-user").length;if(g<1){h.empty();a.getCollaFollwinger("follower",0)}h.show().siblings().hide();break}});$(".mind-colladd-dlg-close").on("click",function(){$("#colla_add").hide();$.mask("close")});$(".colla-context-con").on("click",".colla-follow-more",function(f){var d=$(this).parent().data("type");a[d+"Page"]+=1;a.getCollaFollwinger(d,a[d+"Page"])});$(document).off("click",".colla-team");$(document).on("click",".colla-team",function(i){var h=$(this),g=h.attr("tid"),f=h.find(".icons"),d=f.hasClass("active");if(!d){if($(".colla-team-user[tid="+g+"]").length>0){a.showTeamsMbs(null,g)}else{a.getTeamMembers(g)}f.addClass("active")}else{f.removeClass("active");a.hideTeamMbs(g)}});$(document).off("click",".colla-user, .colla-team-user > div");$(document).on("click",".colla-user, .colla-team-user > div",function(f){var d=$(this).attr("uid"),g=$(this).text();if(a.multiVal.indexOf(d)>=0){return}$("#multi-input-colla").multiInput("setVal",d,g);a.multiVal.push(d);a.multiType.push("user")});$("#send-colla-invite").off().on("click",function(i){var h=$("#colla_add"),d=$("#multi-input");if(d.length>0&&d.val()!=""){var i=$.Event("keyup");i.keyCode=13;d.trigger(i)}var g=a.multiVal;if(g.length==0){return}$("#send-colla-invite").hide();$("#send-colla-invite-loading").show();var f=[];$.ajax({url:"/collaboration/add",data:{type:"email",targets:g.join(","),targetTypes:a.multiType.join(","),folderId:b=="folder"?c:"",chartId:b=="chart"?c:"",role:$("#role").val()},success:function(j){a.multiVal=[];a.multiType=[];$("#send-colla-invite-loading").hide();$("#send-colla-invite").show();$(".multi-input-vals").empty();if(j.result=="success"){mindTip.globalTopTip("邀请协作发送成功","top_success","3000",h,true);a.getRoleList();return false}if(j.result=="exists"){mindTip.globalTopTip("邀请人已加入协作","top_error","5000",h,true)}}})});$("#multi-input-colla").multiInput({setVal:function(d){if(a.multiVal.indexOf(d)>=0){return}a.multiVal.push(d);a.multiType.push("email");return d},deleteVal:function(e){var d=a.multiVal.indexOf(e);a.multiVal.splice(d,1);a.multiType.splice(d,1)}})},multiType:[],multiVal:[],totalCount:0,showCount:0,showCollaList:function(d){var c="";var e=d.users;for(var b=0;b<e.length;b++){var a=e[b];c+='<div><span class="pop-text">'+a.fullName+'</span><span class="pop-text-i"><'+a.email+"></span></div>"}return c},getContacters:function(){var a=this;$.ajax({url:"/collaboration/get_contacter",success:function(b){a.showContacters(b)}})},getTeams:function(){var a=this;$.ajax({url:"/collaboration/get_teams",success:function(b){a.showTeams(b)}})},getCollaFollwinger:function(a,c){mindTip.loadingball({con:$(".colla-context-con")});if(this.loadingcolla){return}this.loadingcolla=true;var b=this;$.ajax({url:"/u/colla/more",data:{page:c,type:a},success:function(d){mindTip.loadingball({close:true});b.loadingcolla=false;b.showFollowinger(d,$("#colla_"+a))}})},getTeamMembers:function(b,c){var a=this,c=c||1;$.ajax({url:"/collaboration/get_teams_mbs",data:{teamId:b,pn:c},success:function(d){a.totalCount=d.total;a.showCount=d.skip;a.showTeamsMbs(d,b);$("#loadMore").off().on("click",function(f){a.getTeamMembers(b,c+1)})}})},showContacters:function(e){var d="";if(e!=null&&e.contacters.length>0){for(var c=0,a=e.contacters.length;c<a;c++){var b=e.contacters[c];if(b==null){continue}d+='<div uid="'+b.userId+'" class="colla-user"><span>'+mindShare.collaboration.loadAvatar(b.userId)+"</span><span>"+b.fullName+"</span></div>"}}else{d="<div class='colla-users-none'><span class='icons'>&#xe63e;</span><div>您还没有最近联系人</div></div>"}$("#colla_users").html(d)},showFollowinger:function(d,g){var f="";var a=d.users.length;var j=g.find(".colla-follow-more");if(a==6){if(j.length<1){j=$("<div class='colla-follow-more'>更多</div>");j.appendTo(g)}j.show()}else{if(a<6){if(j.length>0){j.hide()}}}if(d!=null&&a>0){for(var e=0,h=a;e<h;e++){var c=d.users[e];if(c==null){continue}var b='<div class="user-logo tmu-photo">'+mindShare.collaboration.loadAvatar(c.userId)+"</div>";f+='<div uid="'+c.userId+'" class="colla-user colla-follow-user"><span>'+b+"</span><span>"+c.fullName+"</span></div>"}}g.append(f);if(g.find(".colla-user ").length<1){g.html("<div class='colla-users-none'><div>您还没有关注用户</div></div>")}},showTeams:function(e){var d="";if(e!=null&&e.teams.length>0){for(var c=0,a=e.teams.length;c<a;c++){var b=e.teams[c];if(b==null){continue}d+='<div tid="'+b.groupId+'" class="colla-team"><span>'+mindShare.collaboration.getTeamLogo(b)+'</span><span class="title">'+b.groupName+'</span><span class="mind-icons showteammember">&#xe668;</span></div>'}}else{d="<div class='colla-users-none'><span class='icons'>&#xe60e;</span><div>您还没有小组</div></div>"}$("#colla_teams").html(d)},getTeamLogo:function(b){var a="<span class='mind-icons teamlogo'>&#xe621;</span>";if(b!=null&&b.logoFileName!=null&&b.logoFileName!=""){a="<img src='"+this.getBaseUrl+"/file/response/"+b.logoFileName+"/team_logo'/>"}return a},showTeamsMbs:function(f,h){var e="";if(f!=null&&f.users.length>0){for(var d=0,a=f.users.length;d<a;d++){var b=f.users[d];if(b==null){continue}var c='<div class="user-logo tmu-photo">'+mindShare.collaboration.loadAvatar(b.userId)+"</div>";e+='<div uid="'+b.userId+'"><span>'+c+"</span><span>"+b.fullName+"</span></div>"}var g=$(".colla-team-user[tid="+h+"]");if(g.length==0){g=$("<div class='colla-team-user' tid='"+h+"' ></div>");$(".colla-team[tid="+h+"]").after(g)}if(this.showCount<this.totalCount){if($("#loadMore").length>0){$("#loadMore").before(e)}else{e+="<div id='loadMore' style='padding:0px;height: 12px;width: 50%;margin-left:25%;text-align: center;cursor: pointer;margin-top: 5px;border-radius: 6px;border: 1px solid #dcdcdc;'><span class='icons' style='width:10px;height:10px;margin-top:-3px;'>&#xe618;</span></div>";g.append(e)}}else{g.append(e);$("#loadMore").hide()}}else{$(".colla-team-user[tid="+h+"]").show()}},hideTeamMbs:function(a){$(".colla-team-user[tid="+a+"]").hide()},getRoleList:function(c,b){var a=this;$.ajax({url:"/collaboration/list_users",data:{chartId:chartId,pg:b||1},success:function(d){a.showRoleList(d)}})},showRoleList:function(f){$("#role_list").empty();var e="";if(f.owner!=null){e='<div class="role-item"><span class="item-portrait">'+mindShare.collaboration.loadAvatar(f.owner.userId)+'</span><span class="item-user-fullname">'+f.owner.fullName+'</span><span class="item-role-status"></span><span class="role-sel-con">创建者</span></div>'}if(f.collaborations!=null){for(var d=0;d<f.collaborations.length;d++){var a=f.collaborations[d].user,c=f.collaborations[d];var b='<div class="user-logo tmu-photo">'+mindShare.collaboration.loadAvatar(a.userId)+"</div>";e+='<div id="item_'+c.collborationId+'" class="role-item"><span onclick="mindShare.collaboration.removeRoleUser(\''+c.collborationId+"','"+c.user.userId+'\')" class="mind-icons closeme">&#xe622;</span><span class="item-portrait">'+b+'</span><span class="item-user-fullname">'+a.fullName+'</span><span class="item-role-status" >'+c.email+'</span><span class="role-sel-con" ><select onchange="mindShare.collaboration.setRole(\''+c.collborationId+'\',this)"><option value="editor" '+(c.role=="editor"?'selected="selected"':"")+' ">编辑者</option><option value="viewer" '+(c.role=="viewer"?'selected="selected"':"")+' ">浏览者</option></select></span></div>'}}$("#role_list").html(e)},setRole:function(a,b){if(a!=""){$.ajax({url:"/collaboration/set_role",data:{role:b.value,collaborationId:a},success:function(c){mindTip.globalTopTip("修改成功",null,2000,$("#colla_add"),true)}})}},removeRoleUser:function(b,a){$.ajax({url:"/collaboration/delete",data:{type:"user",collaborationId:b},success:function(c){$("#item_"+b).remove()}})},renderExcludeInut:function(d){var b="";for(var c=0,a=d.length;c<a;c++){b+='<span val="'+d[0]+'" class="multi-input-value"><span class="icons" style="color:#f60;">&#xe614;</span><span class="multi-text" style="color:#f60;">'+d[0]+'</span><span class="mind-icons closeme" style="color:#f20;">&#xe622;</span></span>'}$(".multi-input-vals").append(b)}}};